<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC | Teacher Attendance v1</title> <link rel="shortcut icon" type="image/png" href="https://img2.pic.in.th/pic/Pakchong_School-removebg-preview.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">


    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        .page-section { display: none; } /* Hide all sections initially */
        .page-section.active { display: block; } /* Show active section */
        #schoolBanner { max-height: 290px; width: 100%; object-fit: cover; margin-bottom: 0.2rem; } /* Banner style */
        #schoolLogo { max-height: 60px; width: auto; }
        #clock-home, #clock-checkin { font-size: 1.0rem; font-weight: bold; }
        .teacher-photo { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid #dee2e6; }
        .signature-pad-container { position: relative; width: 100%; height: 150px; background-color: #ffffff; cursor: crosshair; border: 1px solid #ced4da; border-radius: 0.375rem; }
        #signatureCanvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; border-radius: 0.375rem; }
        #videoFeed { width: 100%; height: auto; max-height: 200px; display: none; background-color: #343a40; } /* Hidden initially */
        .captured-photo { max-height: 200px; display: block; margin-left: auto; margin-right: auto; background-color: #e9ecef; }
        .form-label { margin-bottom: 0.5rem; font-weight: bold; }
        .btn-group-camera button { margin: 0 3px; }
        .card-title { margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: normal;} /* Adjusted card title size */
        .card-text { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.2rem;} /* Adjusted card text margin */
        .card-text-small { font-size: 0.75em; color: rgba(255, 255, 255, 0.8); } /* Smaller text for units */
        .loading-overlay {
            position: fixed; /* Changed to fixed for full page */
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.8); z-index: 1060; /* Higher z-index */
            display: none; /* Hidden by default */ align-items: center; justify-content: center;
        }
         .loading-overlay.active { display: flex; } /* Show when active */

        .table-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 5px; vertical-align: middle; transition: transform 0.2s ease-in-out; }
        .table-img:hover { transform: scale(1.5); } /* Simple hover zoom */
        .dashboard-table-img, .stats-table-img { cursor: pointer; } /* Add pointer cursor */
        #dashboardTable td, #statsTable td { vertical-align: middle; font-size: 0.9rem; } /* Adjust table font size */
        #dashboardTable th, #statsTable th { font-size: 0.9rem; }
        .small-text { font-size: 0.85em; }
        .teacher-profile-card { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .teacher-profile-card img { width: 80px; height: 80px; }

        /* DataTables specific adjustments */
        .dataTables_wrapper .row { margin-bottom: 0.5rem;}
         div.dataTables_wrapper div.dataTables_filter input { width: 150px; display: inline-block; margin-left: 0.5em;}
         div.dataTables_wrapper div.dataTables_length select { width: auto; display: inline-block; }
         div.dataTables_wrapper div.dataTables_info,
         div.dataTables_wrapper div.dataTables_paginate { padding-top: 0.5em; font-size: 0.85rem;}

        /* Footer style */
        .footer { background-color: #e9ecef; color: #6c757d; padding: 10px 0; font-size: 0.8em;}
        .footer a { color: #dc3545; text-decoration: none; }

         /* Navigation Buttons */
         .main-nav .btn { margin: 0 2px; }

        @media (max-width: 767.98px) {
            .teacher-photo { max-width: 80px; height: 80px; margin-bottom: 1rem; }
            #videoFeed, .captured-photo { max-height: 150px; }
            .signature-pad-container { height: 120px; }
            .card-text { font-size: 1.2rem; }
            #schoolLogo { max-height: 50px; }
            .card-header h5, .card-header h6 { font-size: 0.9rem;}
            .main-nav .btn { font-size: 0.8rem; padding: 0.3rem 0.5rem;} /* Adjust button size */
             /* Adjust datatables filter/length */
            div.dataTables_wrapper div.dataTables_filter { text-align: left !important; float: none !important; }
            div.dataTables_wrapper div.dataTables_length {text-align: left !important; float: none !important; margin-top: 0.5rem;}
            div.dataTables_wrapper div.dataTables_filter input { width: auto;}
             #schoolBanner { max-height: 150px; } /* Smaller banner on mobile */
        }
    </style>
</head>
<body>
     <div id="pageLoadingOverlay" class="loading-overlay">
         <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
             <span class="visually-hidden">Loading...</span>
         </div>
     </div>

    <div class="container-fluid mt-3 mb-4">

        <div class="card shadow-sm border-primary position-relative">

            <div class="card-body p-3 p-md-4">
				
                <img src="https://lh5.googleusercontent.com/d/1v1vBqESxt2BT37goqT0UGvEuw7yjKCTy" alt="‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" id="schoolBanner" class="img-fluid rounded"> <div class="container text-center my-3 main-nav btn-group shadow-sm flex-wrap" role="group" aria-label="Main Navigation"> <button type="button" class="btn btn-outline-primary active" data-target="homePage">
                     <i class="fas fa-home me-1"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                     </button>
                    <button type="button" class="btn btn-outline-primary" data-target="dashboardPage">
                        <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-target="checkinPage">
                        <i class="fas fa-edit me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-target="searchPage">
                        <i class="fas fa-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                    </button>
                </div>


                <div id="homePage" class="page-section active">
				
				<div class="container-fluid mt-0 mb-1 bg-light">
				<marquee behavior="scroll" direction="left" 
				style="color:	#000000; font-size: 18px;mt-2 mb-2" onmouseover="this.stop();" onmouseout="this.start();"><h6 style="mt-2">
				<h5><img src="https://lh5.googleusercontent.com/d/1cD2nVKNscJg1DJPnkaakah7Nz4ez_BZS" height="12" width="25" >&nbsp;‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á :: ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ KT | Tanasarn Sirak&nbsp;<img src="https://lh5.googleusercontent.com/d/1cD2nVKNscJg1DJPnkaakah7Nz4ez_BZS" height="12" width="25" ></h5></marquee>        
				</div>
				
				
                    <div id="clock-home" class="alert alert-info text-center shadow-sm py-2 mt-3" role="alert">
                         <i class="fas fa-clock me-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...
                     </div>

                    <div class="text mb-4">
                        <div id="info" style="font-size:14px" class="alert alert-warning text-left shadow-sm" role="alert">
                            <i class="fas fa-info-circle me-2"></i><b> ‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</b>
                            <br>1. <b>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ñ‡∏∑‡∏≠ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</b></br>
                            2. <b>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π </b> ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πâ‡∏≤ : <b>07:00-07.20 ‡∏ô.</b> || ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡πá‡∏ô : <b>16:20-17.10 ‡∏ô.</b></br>
                            3. <b>‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ >></b> ‡πÄ‡∏ä‡πâ‡∏≤ : <b>07:00-07.50 ‡∏ô.</b> || ‡πÄ‡∏¢‡πá‡∏ô : <b>16:20-17.10 ‡∏ô.</b></br>
                            4. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° <button type="button" class="btn btn-sm btn-outline-primary disabled py-0"><i class="fas fa-edit me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ </br>
                            5. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üëâ <a style="color:#000;cursor:pointer" target="_blank" href="https://line.me/ti/p/3F7VGrqgUr">‡∏≠.‡∏ò‡∏ô‡∏™‡∏≤‡∏£ ‡∏™‡∏µ‡∏£‡∏±‡∏Å‡∏©‡πå</a>
                        </div>
                        <hr>

                        <h5 class="mt-4 mb-3"><i class="fas fa-chart-bar me-2 text-success"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h5>
                        <div class="row g-3 mb-3">
                           <div class="col-md-4">
                               <div class="card text-white bg-primary shadow-sm h-100">
                                   <div class="card-body p-2">
                                       <h6 class="card-title"><i class="fas fa-users me-1"></i> ‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                                       <p class="card-text" id="homeLoggedToday">-</p>
                                        <small class="card-text-small">(‡∏Ñ‡∏ô)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-dark bg-info shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-door-open me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h6>
                                        <p class="card-text" id="homeGateDutyToday">-</p>
                                        <small class="card-text-small">(‡∏Ñ‡∏ô)</small>
                                        </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-dark bg-warning shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-building me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h6>
                                        <p class="card-text" id="homeBuildingDutyToday">-</p>
                                         <small class="card-text-small">(‡∏Ñ‡∏ô)</small>
                                        </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                         </div>
                      <div class="text-center mt-4">
                         <a style="color:black;text-decoration:none;font-size:12px"><b><i class="fas fa-chart-line"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô : </b></a>
                         <a href="https://www.freecounterstat.com" title="hit counters for websites"><img src="https://counter4.optistats.ovh/private/freecounterstat.php?c=uxl7ktjxcfulq4s18eams772gxzgjehu" border="0" title="free hit counter" alt="free hit counter" style="vertical-align: middle;"></a>
                    </div>
                </div>
                <div id="dashboardPage" class="page-section">
				<div id="dashboardPage-t" class="alert alert-info text-center shadow-sm py-2" role="alert">
                           <h5 class="mb-3 mt-3"><i class="fas fa-tachometer-alt me-2 text-primary"></i><b> Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                     </div>
				

                     <div class="row g-3 mb-3">
                         <div class="col-md-4">
                             <div class="card text-white bg-success shadow-sm h-100">
                                 <div class="card-body p-2">
                                     <h6 class="card-title"><i class="fas fa-users me-1"></i> ‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
                                     <p class="card-text" id="loggedTodayCount">0 / 0</p>
                                     <small class="card-text-small">(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</small>
                                 </div>
                             </div>
                         </div>
                          <div class="col-md-4">
                             <div class="card text-dark bg-info shadow-sm h-100">
                                 <div class="card-body p-2">
                                     <h6 class="card-title"><i class="fas fa-door-open me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</h6>
                                     <p class="card-text" id="gateDutyCount">0</p>
                                     <small class="card-text-small">(‡∏Ñ‡∏ô - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</small>
                                     </div>
                             </div>
                         </div>
                         <div class="col-md-4">
                             <div class="card text-dark bg-warning shadow-sm h-100">
                                 <div class="card-body p-2">
                                     <h6 class="card-title"><i class="fas fa-building me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</h6>
                                     <p class="card-text" id="buildingDutyCount">0</p>
                                     <small class="card-text-small">(‡∏Ñ‡∏ô - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</small>
                                      </div>
                             </div>
                         </div>
                     </div>
                     <div class="row g-2 mb-3 align-items-center bg-light p-2 rounded border shadow-sm">
                         <div class="col-lg-3 col-md-6">
                             <label for="dashboardDateFilter" class="form-label small mb-0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                             <input type="text" class="form-control form-control-sm" id="dashboardDateFilter" name="dashboardDateFilter">
                         </div>
                         <div class="col-lg-2 col-md-6">
                             <label for="dashboardLevelFilter" class="form-label small mb-0">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</label> <select class="form-select form-select-sm" id="dashboardLevelFilter">
                                 <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                 </select>
                         </div>
                         <div class="col-lg-3 col-md-6">
                             <label for="dashboardDutyFilter" class="form-label small mb-0">‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</label>
                             <select class="form-select form-select-sm" id="dashboardDutyFilter">
                                 <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                 <option value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π</option>
                                 <option value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                                 <option value="‡∏•‡∏≤">‡∏•‡∏≤</option>
                                 <option value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                                 <option value="‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)">‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>
                             </select>
                         </div>
                          <div class="col-lg-2 col-md-3 d-grid align-self-end">
                              <button class="btn btn-sm btn-primary" id="refreshDashboardBtn" title="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà">
                                  <i class="fas fa-sync-alt"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                              </button>
                          </div>
                          <div class="col-lg-2 col-md-3 align-self-end text-end text-muted small" id="dashboardTableDate">
                               ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: -
                           </div>
                     </div>
                     <div class="table-responsive">
                         <table id="dashboardTable" class="table table-striped table-bordered table-hover" style="width:100%">
                             <thead class="table-light">
                                 <tr>
                                     <th>‡∏£‡∏π‡∏õ</th> <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th> <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th> <th>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th> </tr>
                             </thead>
                             <tbody>
                                 </tbody>
                         </table>
                     </div>
                     </div>
                <div id="checkinPage" class="page-section">
				
				<div class="row alert alert-info text-center shadow-sm py-2" role="alert" ><b><div class="clock text-light mt-1 ml-1 text-center text-dark" id="MyClockDisplay" onload="showTime()"></div></div>
                    
                     <!-- <div id="clock-checkin" class="alert alert-info text-center shadow-sm py-2" role="alert">
                         <i class="fas fa-clock me-2"></i><b> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...
                     </div> -->
					<h5 class="mb-4"><i class="fas fa-edit me-2 text-primary"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h5>
                    <form id="checkinForm" novalidate>
                         <div class="mb-3">
                             <!--<label for="teacherId" class="form-label"><i class="fas fa-id-card me-2 text-primary"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (4 ‡∏ï‡∏±‡∏ß)</label> -->
							   <label for="teacherId" style="margin-left: 12px; margin-left: 15px; 
                             margin-top: -14px; position: absolute; background-color: white; border: 2px solid white;"><i class="fas fa-id-card me-2 text-primary"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (4 ‡∏ï‡∏±‡∏ß)</label>
                             <input type="tel" class="form-control form-control-xl border border-danger "  style="height: 3.8rem;" id="teacherId" name="teacherId" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (4 ‡∏ï‡∏±‡∏ß)" maxlength="4" inputmode="numeric" pattern="[0-9]*"> <div id="teacherLookupStatus" class="form-text mt-1 small text-muted"></div>
                         </div>

                         <div id="teacherInfo" class="form-section mb-3" style="display:none;">
                              <div class="row align-items-center gx-2 gy-2">
                                 <div class="col-auto">
                                     <img src="https://placehold.co/100x100/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" id="teacherPhoto" class="teacher-photo">
                                 </div>
                                 <div class="col">
                                     <p class="mb-1 small"><strong><i class="fas fa-user fa-fw me-1"></i>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="teacherName"></span></p>
                                     <p class="mb-1 small"><strong><i class="fas fa-chalkboard-teacher fa-fw me-1"></i>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø:</strong> <span id="teacherDepartment"></span></p>
                                     <p class="mb-0 small"><strong><i class="fas fa-user-tie fa-fw me-1"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> <span id="teacherPosition"></span></p>
                                     <input type="hidden" id="hiddenTeacherName" name="teacherName">
                                     <input type="hidden" id="hiddenTeacherDepartment" name="teacherDepartment">
                                 </div>
                             </div>
                         </div>

                        <div id="dutyStatusSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-clipboard-check me-2 text-primary"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusPresent" value="‡∏°‡∏≤" required>
                                <label class="form-check-label" for="statusPresent"> <i class="fas fa-user-check text-success me-1"></i> ‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusLeave" value="‡∏•‡∏≤">
                                <label class="form-check-label" for="statusLeave"> <i class="fas fa-calendar-times text-warning me-1"></i> ‡∏•‡∏≤ </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusBusinessTrip" value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">
                                <label class="form-check-label" for="statusBusinessTrip"> <i class="fas fa-plane-departure text-info me-1"></i> ‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ </label>
                            </div>
                            <div id="dutyStatusError" class="invalid-feedback d-block small"></div>
                            <div class="section-loading-overlay" id="dutySubSectionsLoading" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                            </div>
                        </div>

                        <div id="dutyTypeSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-tasks me-2 text-secondary"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyGate" value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">
                                <label class="form-check-label" for="dutyGate"> <i class="fas fa-door-open text-success me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyBuilding" value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">
                                <label class="form-check-label" for="dutyBuilding"> <i class="fas fa-building text-warning me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ </label>
                            </div>
                            <div id="dutyTypeError" class="invalid-feedback d-block small"></div>
                        </div>

                        <div id="remarksSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label for="remarks" class="form-label"><i class="fas fa-pencil-alt me-2 text-secondary"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£"></textarea>
                            <div id="remarksError" class="invalid-feedback d-block small"></div>
                        </div>

                        <div id="locationSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-map-marker-alt me-2 text-danger"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                            <div id="locationInfo" class="form-control form-control-sm bg-light" style="min-height: 35px;">
                                <span class="text-muted small"></span> <button type="button" class="btn btn-xs btn-outline-secondary ms-2 py-0 px-1 float-end" id="getLocationBtn" title="‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"> <i class="fas fa-sync"></i> </button>
                            </div>
                            <input type="hidden" id="latitude" name="latitude"> <input type="hidden" id="longitude" name="longitude">
                            <div id="locationError" class="form-text text-danger mt-1 small"></div>
                        </div>

                        <div id="signatureSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label for="signatureCanvas" class="form-label"><i class="fas fa-signature me-2 text-success"></i>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠</label>
                            <div class="signature-pad-container"> <canvas id="signatureCanvas"></canvas> </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="resetSignatureBtn"><i class="fas fa-eraser me-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                            <input type="hidden" id="signatureData" name="signatureData"> <div id="signatureError" class="invalid-feedback d-block small"></div>
                        </div>

                       <div id="photoSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-camera me-2 text-info"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡πâ‡∏ô</label>
                            <div class="row g-2 align-items-start">
                                <div class="col-md-6">
                                    <video id="videoFeed" playsinline autoplay muted class="img-fluid border rounded bg-dark w-100"></video> <canvas id="photoCanvas" style="display:none;"></canvas>
                                </div>
                                <div class="col-md-6 text-center">
                                    <img id="capturedPhotoPreview" src="https://placehold.co/300x200/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢" class="img-fluid border rounded mb-2 captured-photo">
                                    <input type="hidden" id="photoData" name="photoData"> </div>
                            </div>
                            <div class="mt-2 text-center btn-group-camera">
                                <button type="button" class="btn btn-sm btn-info" id="startCameraBtn"><i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                                <button type="button" class="btn btn-sm btn-success" id="capturePhotoBtn" disabled><i class="fas fa-camera-retro me-1"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="resetPhotoBtn" disabled><i class="fas fa-undo me-1"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                            <div id="cameraError" class="form-text text-danger mt-1 text-center small"></div>
                            <div id="photoError" class="invalid-feedback d-block text-center small"></div>
                        </div>

                        <div id="submitButtonSection" class="form-section d-grid gap-2 mt-4 pt-3 border-top" style="display:none;">
                            <button type="submit" class="btn btn-secondary btn-lg fw-bold shadow" id="submitBtn" disabled>
                            <i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
                            </button>
                        </div>

                         <div id="statusMessage" class="mt-3 small"></div> </form>
                </div>
                 <div id="searchPage" class="page-section">
				    <div id="searchPage-t" class="alert alert-info text-center shadow-sm py-2" role="alert">
                           <h5 class="mb-3 mt-3"><i class="fas fa-search me-2 text-primary"></i><b> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h5>
                     </div>

                    <div class="row g-2 mb-3 align-items-end bg-light p-3 rounded border shadow-sm">
                        <div class="col-md-4">
                            <!--<label for="searchTeacherId" class="form-label small">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (4 ‡∏ï‡∏±‡∏ß):</label>-->
							<label for="searchTeacherId" style="margin-left: 12px; margin-left: 15px; 
                             margin-top: -14px; position: absolute; background-color: white; border: 2px solid white;"><i class="fas fa-id-card me-2 text-primary"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (4 ‡∏ï‡∏±‡∏ß)</label>
                            <input type="tel" class="form-control form-control  border border-danger "  style="height: 3.3rem;" id="searchTeacherId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (4 ‡∏ï‡∏±‡∏ß)" maxlength="4" inputmode="numeric" pattern="[0-9]*">
                        </div>
                        <div class="col-md-3 d-grid">
                            <button class="btn btn-lg btn-primary" id="searchStatsBtn">
                                <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </div>
                        <div class="col-md-5">
                             <div id="searchMessage" class="mt-2 small text-muted"></div>
                        </div>
                    </div>
                    <div id="searchResultArea" style="display: none;">
                        <hr>

                        <div class="row g-3 mb-3">
                            <div class="col-sm-6 col-md-3">
                                <div class="card text-white bg-primary shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-calendar-alt me-1"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h6>
                                        <p class="card-text" id="statsTotalDays">0</p>
                                        <small class="card-text-small">(‡∏ß‡∏±‡∏ô)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <div class="card text-white bg-success shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-user-check me-1"></i> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</h6>
                                        <p class="card-text" id="statsPresentDays">0</p>
                                         <small class="card-text-small">(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                                    </div>
                                </div>
                            </div>
                             <div class="col-sm-6 col-md-3">
                                <div class="card text-dark bg-warning shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-calendar-times me-1"></i> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≤</h6>
                                        <p class="card-text" id="statsLeaveDays">0</p>
                                         <small class="card-text-small">(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                                     </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <div class="card text-white bg-info shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-plane-departure me-1"></i> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h6>
                                         <p class="card-text" id="statsTripDays">0</p>
                                        <small class="card-text-small">(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                                     </div>
                                 </div>
                             </div>
                         </div>
                        <div id="statsTeacherInfo" class="teacher-profile-card">
                            <div class="row align-items-center gx-3">
                                <div class="col-auto">
                                    <img src="https://placehold.co/80x80/adb5bd/ffffff?text=?" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" id="statsTeacherPhoto" class="rounded-circle">
                                </div>
								<div class="col-auto">
                                    <h6 class="mb-1" >‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• :: </h6>
                                    <p class="mb-0 small-text text-muted" >‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø :: </p>
                                    <p class="mb-0 small-text text-muted" >‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:: </p>
                                </div>
								
                                <div class="col-auto">
                                    <h6 class="mb-1" id="statsTeacherName">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</h6>
                                    <p class="mb-0 small-text text-muted" id="statsTeacherDepartment">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
                                    <p class="mb-0 small-text text-muted" id="statsTeacherLevel">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: N/A</p>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-3 align-items-center bg-light p-2 rounded border">
                           <div class="col-md-5">
                               <label for="statsDateFilter" class="form-label small mb-0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</label>
                               <input type="text" class="form-control form-control-sm" id="statsDateFilter" name="statsDateFilter">
                           </div>
                           <div class="col-md-4">
                               <label for="statsDutyFilter" class="form-label small mb-0">‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</label>
                               <select class="form-select form-select-sm" id="statsDutyFilter">
                                   <option value="" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option> <option value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π</option>
                                   <option value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                                   <option value="‡∏•‡∏≤">‡∏•‡∏≤</option>
                                   <option value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                                   <option value="‡∏°‡∏≤ \(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\)">‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option> </select>
                           </div>
                            <div class="col-md-3 d-grid align-self-end">
                              <button class="btn btn-sm btn-outline-secondary" id="resetStatsFilterBtn" title="‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">
                                  <i class="fas fa-times"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                              </button>
                          </div>
                       </div>
                       <h6><i class="fas fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
                        <div class="table-responsive">
                             <table id="statsTable" class="table table-striped table-bordered table-hover" style="width:100%">
                                 <thead class="table-light">
                                     <tr>
                                         <th>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th> <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th> <th>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th> </tr>
                                 </thead>
                                 <tbody>
                                     </tbody>
                             </table>
                         </div>
                    </div>
                    </div>
                 <footer class="footer mt-4 text-center">
                    <div class="container">
                         <a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"><i class="fa-solid fa-comments"></i> ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a> || ¬©Ô∏èKT|Tanasarn Sirak (v1)
                     </div>
                 </footer>
                 </div> </div> </div> <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script> <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/moment/locale/th.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        // --- Apps Script Web App URL ---
        // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Deploy Apps Script v5.1 (‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß) !!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGDiaBYxsXesotxCB-8sreCkYrRl4hUC0LTqCnXrSp8_QYM8r3YNVyZ3HYDyaHdmGeKw/exec'; // <<--- PASTE YOUR DEPLOYED URL HERE

        // --- DOM Elements ---
        const mainNavButtons = document.querySelectorAll('.main-nav .btn');
        const pageSections = document.querySelectorAll('.page-section');
        const pageLoadingOverlay = document.getElementById('pageLoadingOverlay');

        // Page Specific Elements
        const homePage = document.getElementById('homePage');
        const dashboardPage = document.getElementById('dashboardPage');
        const checkinPage = document.getElementById('checkinPage');
        const searchPage = document.getElementById('searchPage');

        // Home Page Clock & Stats
         const clockElementHome = document.getElementById('clock-home');
         const homeLoggedTodayEl = document.getElementById('homeLoggedToday');
         const homeGateDutyTodayEl = document.getElementById('homeGateDutyToday');
         const homeBuildingDutyTodayEl = document.getElementById('homeBuildingDutyToday');

        // Dashboard Elements
        const loggedTodayCountEl = document.getElementById('loggedTodayCount');
        const gateDutyCountEl = document.getElementById('gateDutyCount');
        const buildingDutyCountEl = document.getElementById('buildingDutyCount');
        const dashboardDateFilterEl = document.getElementById('dashboardDateFilter');
        const dashboardLevelFilterEl = document.getElementById('dashboardLevelFilter'); // New
        const dashboardDutyFilterEl = document.getElementById('dashboardDutyFilter');
        const refreshDashboardBtn = document.getElementById('refreshDashboardBtn');
        const dashboardTableEl = $('#dashboardTable'); // jQuery selector
        let dashboardDataTable = null;
        const dashboardTableDateEl = document.getElementById('dashboardTableDate');

        // Check-in Elements
        const clockElementCheckin = document.getElementById('clock-checkin');
        const checkinForm = document.getElementById('checkinForm');
        const teacherIdInput = document.getElementById('teacherId');
        const teacherLookupStatus = document.getElementById('teacherLookupStatus');
        const teacherInfoDiv = document.getElementById('teacherInfo');
        const dutyStatusSection = document.getElementById('dutyStatusSection');
        const dutyTypeSection = document.getElementById('dutyTypeSection');
        const remarksSection = document.getElementById('remarksSection');
        const locationSection = document.getElementById('locationSection');
        const signatureSection = document.getElementById('signatureSection');
        const photoSection = document.getElementById('photoSection');
        const submitButtonSection = document.getElementById('submitButtonSection');
        const dutySubSectionsLoading = document.getElementById('dutySubSectionsLoading');
        const teacherPhoto = document.getElementById('teacherPhoto'); // Profile photo on check-in page
        const teacherNameSpan = document.getElementById('teacherName');
        const teacherDepartmentSpan = document.getElementById('teacherDepartment');
        const teacherPositionSpan = document.getElementById('teacherPosition');
        const hiddenTeacherName = document.getElementById('hiddenTeacherName');
        const hiddenTeacherDepartment = document.getElementById('hiddenTeacherDepartment');
        const dutyStatusRadios = document.querySelectorAll('input[name="dutyStatus"]');
        const dutyTypeRadios = document.querySelectorAll('input[name="dutyType"]');
        const remarksInput = document.getElementById('remarks');
        const dutyStatusErrorDiv = document.getElementById('dutyStatusError');
        const dutyTypeErrorDiv = document.getElementById('dutyTypeError');
        const remarksErrorDiv = document.getElementById('remarksError');
        const locationInfoDiv = document.getElementById('locationInfo');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const locationErrorDiv = document.getElementById('locationError');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const resetSignatureBtn = document.getElementById('resetSignatureBtn');
        const signatureDataInput = document.getElementById('signatureData');
        const signatureErrorDiv = document.getElementById('signatureError');
        const videoFeed = document.getElementById('videoFeed');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhotoPreview = document.getElementById('capturedPhotoPreview'); // Check-in photo preview
        const photoDataInput = document.getElementById('photoData'); // Check-in photo base64
        const startCameraBtn = document.getElementById('startCameraBtn');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const resetPhotoBtn = document.getElementById('resetPhotoBtn');
        const cameraErrorDiv = document.getElementById('cameraError');
        const photoErrorDiv = document.getElementById('photoError');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage'); // For check-in status

        // Search Statistics Elements
        const searchTeacherIdInput = document.getElementById('searchTeacherId');
        const searchStatsBtn = document.getElementById('searchStatsBtn');
        const searchResultArea = document.getElementById('searchResultArea');
        // -- Stats Cards
        const statsTotalDaysEl = document.getElementById('statsTotalDays');
        const statsPresentDaysEl = document.getElementById('statsPresentDays');
        const statsLeaveDaysEl = document.getElementById('statsLeaveDays');
        const statsTripDaysEl = document.getElementById('statsTripDays');
        // -- Teacher Info
        const statsTeacherInfoDiv = document.getElementById('statsTeacherInfo');
        const statsTeacherPhoto = document.getElementById('statsTeacherPhoto'); // Profile photo on stats page
        const statsTeacherName = document.getElementById('statsTeacherName');
        const statsTeacherDepartment = document.getElementById('statsTeacherDepartment');
        const statsTeacherLevel = document.getElementById('statsTeacherLevel'); // Added Level display
        // -- Filters
        const statsDateFilterEl = document.getElementById('statsDateFilter'); // New Date Filter
        const statsDutyFilterEl = document.getElementById('statsDutyFilter'); // New Duty Filter
        const resetStatsFilterBtn = document.getElementById('resetStatsFilterBtn'); // New Reset Button
        // -- Table
        const statsTableEl = $('#statsTable'); // jQuery selector
        let statsDataTable = null;
        const searchMessage = document.getElementById('searchMessage'); // For search status

        // --- State Variables ---
        let signaturePad; let stream = null; let teacherDataCache = null;
        let locationWatcher = null; let isSubmitting = false;
        let checkinAllowed = false; let currentCheckinWindow = null;
        let locationAcquired = false;
        let dashboardDataCache = null; // Cache for dashboard table data
        let statsDataCache = null; // Cache for stats table data

        // --- Constants ---
        // Client-side time check values (should match server-side if possible)
        const MORNING_START_TIME = "07:00";
        const MORNING_END_TIME = "07:50"; // Ensure this matches Apps Script
        const AFTERNOON_START_TIME = "16:20"; // Ensure this matches Apps Script
        const AFTERNOON_END_TIME = "17:10"; // Ensure this matches Apps Script
        const PLACEHOLDER_IMG = 'https://placehold.co/100x100/adb5bd/ffffff?text=?';
        const DEFAULT_PROFILE_IMG = 'https://placehold.co/40x40/adb5bd/ffffff?text=?'; // For tables (profile pic)
        const CHECKIN_PHOTO_PLACEHOLDER = 'https://placehold.co/40x40/e9ecef/6c757d?text=N/A'; // For tables (check-in pic)
        const PHOTO_PREVIEW_PLACEHOLDER = 'https://placehold.co/300x200/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check URL immediately
            if (!SCRIPT_URL || SCRIPT_URL.includes('YOUR_SCRIPT_URL') || SCRIPT_URL.length < 60) { // Basic check
                 showSweetAlert('error','Config Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SCRIPT_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Apps Script', false);
                 document.querySelectorAll('button, input, select, textarea').forEach(el => el.disabled = true);
                 return; // Stop further execution
            }

            // Setup Moment.js locale
            moment.locale('th');

            initializeNavigation();
            initializeClock(); // Update clock on load
            initializeSignaturePad();
            initializeDashboard(); // Includes table and filters
            initializeSearchStats(); // Includes table and filters
            initializeCheckinFormLogic();

            setInterval(updateClockAndButtonState, 1000); // Update clock and check-in button state
            window.addEventListener('resize', resizeCanvas);

             // Activate the default page (Home)
             switchPage('homePage');
        });

        // --- Helper Functions ---

        function showLoading(show) {
            if (show) {
                 pageLoadingOverlay.classList.add('active');
            } else {
                 // Delay hiding slightly to prevent flicker if content loads quickly
                 setTimeout(() => pageLoadingOverlay.classList.remove('active'), 200);
             }
        }

        function showSweetAlert(icon, title, html = '', timer = true) {
             const config = { icon: icon, title: title, html: html, confirmButtonText: '‡∏õ‡∏¥‡∏î' };
             if (timer) config.timer = icon === 'success' ? 2500 : 4000;
             if (timer) config.timerProgressBar = true;
             Swal.fire(config);
        }

        function showSuccessSweetAlert(checkinTime, teacherName, photoUrl) {
            // Show check-in photo in success message only if available
             let imageHtml = '';
             if (photoUrl && photoUrl !== CHECKIN_PHOTO_PLACEHOLDER) {
                 imageHtml = `<img src="${photoUrl}" alt="Check-in Photo" style="max-width:150px; max-height:150px; margin-top:10px; border-radius:5px; border: 1px solid #ddd;">`;
             }
            Swal.fire({
                icon: 'success',
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                html: `<p class="mb-1"><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${checkinTime}</p>
                       <p class="mb-2"><strong>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${teacherName}</p>
                       ${imageHtml}`,
                confirmButtonText: '‡∏õ‡∏¥‡∏î',
                timer: 3500, // Slightly longer timer
                timerProgressBar: true
            });
        }

        /**
         * Formats an ISO 8601 timestamp string or Date object into Thai format:
         * Example: 30/‡∏û.‡∏Ñ./2568, 11:28:00 ‡∏ô.
         * @param {string|Date} dateInput - The ISO string or Date object.
         * @returns {string} Formatted Thai date and time string, or 'Invalid Date'
         */
        function formatThaiDateTimeCustom(dateInput) {
            try {
                const date = moment(dateInput); // Use moment for reliable parsing
                if (!date.isValid()) { return 'Invalid Date'; }
                // Ensure correct year (+543) and Thai formatting
                const thaiYear = date.year() + 543;
                 // Format: DD/MMM/YYYY, HH:mm:ss ‡∏ô. (Uses 'th' locale for MMM)
                 return date.format('DD/MMM/') + thaiYear + date.format(', HH:mm:ss ‡∏ô.');
             } catch (error) {
                console.error("Error formatting custom date:", dateInput, error);
                return 'Invalid Date';
            }
        }

         /**
          * Formats only the date part into Thai format.
          * Example: ‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ 30 ‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏° 2568
          * @param {string|Date} dateInput - The ISO string or Date object.
          * @returns {string} Formatted Thai date string, or 'Invalid Date'
          */
         function formatThaiDate(dateInput) {
             try {
                 const date = moment(dateInput);
                 if (!date.isValid()) { return 'Invalid Date'; }
                 const thaiYear = date.year() + 543;
                 return date.format('dddd D MMMM ') + thaiYear;
             } catch (error) {
                 console.error("Error formatting date (short):", dateInput, error);
                 return 'Invalid Date';
             }
         }

        // --- Navigation Logic ---
        function initializeNavigation() {
            mainNavButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPageId = button.getAttribute('data-target');
                    switchPage(targetPageId);
                });
            });
        }

        function switchPage(targetPageId) {
            showLoading(true); // Show loading indicator during page switch

            // Deactivate all sections and buttons
            pageSections.forEach(section => section.classList.remove('active'));
            mainNavButtons.forEach(btn => btn.classList.remove('active'));

            // Activate the target section and button
            const targetSection = document.getElementById(targetPageId);
            const targetButton = document.querySelector(`.main-nav .btn[data-target="${targetPageId}"]`);

            if (targetSection) {
                targetSection.classList.add('active');
                console.log(`Switched to page: ${targetPageId}`);

                // Load data or perform actions specific to the page
                if (targetPageId === 'homePage') {
                     loadHomepageStats(); // Load stats when home is shown
                } else if (targetPageId === 'dashboardPage') {
                    loadDashboardData(); // Load data when dashboard is shown
                } else if (targetPageId === 'checkinPage') {
                     resizeCanvas(); // Ensure signature pad resizes correctly when shown
                     // Optional: reset check-in form state if needed
                } else if (targetPageId === 'searchPage') {
                    // Optional: clear search results or reset fields when switching to search page
                    // searchTeacherIdInput.value = '';
                    // searchResultArea.style.display = 'none';
                    // searchMessage.textContent = '';
                    // if(statsDataTable) statsDataTable.clear().draw();
                }
            }

            if (targetButton) {
                targetButton.classList.add('active');
            }

            // Hide loading indicator after a short delay to allow rendering
            setTimeout(() => showLoading(false), 100); // Slightly longer delay
        }

        // --- Homepage Stats Function ---
        async function loadHomepageStats() {
             if (!homePage.classList.contains('active') || SCRIPT_URL.includes('YOUR_SCRIPT_URL')) return;

             // Indicate loading on cards
             homeLoggedTodayEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
             homeGateDutyTodayEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
             homeBuildingDutyTodayEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

             const todayDate = moment().format('YYYY-MM-DD');
             const url = `${SCRIPT_URL}?action=getDashboardData&date=${todayDate}`;

             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`Server error (${response.status})`);
                 const data = await response.json();
                 console.log("Homepage Stats Received:", data);

                 if (data.status === 'success' && data.counts) {
                     homeLoggedTodayEl.textContent = data.counts.loggedToday || 0;
                     homeGateDutyTodayEl.textContent = data.counts.gateDutyLogged || 0;
                     homeBuildingDutyTodayEl.textContent = data.counts.buildingDutyLogged || 0;
                 } else {
                      throw new Error(data.message || 'Failed to load homepage stats');
                 }
             } catch (error) {
                 console.error('Error loading homepage stats:', error);
                 homeLoggedTodayEl.textContent = 'Error';
                 homeGateDutyTodayEl.textContent = 'Error';
                 homeBuildingDutyTodayEl.textContent = 'Error';
             }
        }


        // --- Dashboard Functions ---

        function initializeDashboard() {
             // Initialize Date Range Picker
             $(dashboardDateFilterEl).daterangepicker({
                 singleDatePicker: true, showDropdowns: true, autoApply: true, // Apply date immediately on selection
                 locale: {
                     format: 'YYYY-MM-DD', // Value format
                     applyLabel: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', cancelLabel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                     daysOfWeek: moment.weekdaysMin(), monthNames: moment.monthsShort(),
                     firstDay: moment.localeData('th').firstDayOfWeek()
                 },
                 maxDate: moment() // Limit selection up to today
             }, function(start, end, label) {
                 console.log("Dashboard Date selected: ", start.format('YYYY-MM-DD'));
                 loadDashboardData(); // Reload data when date changes
             });
             // Set initial date to today
             $(dashboardDateFilterEl).data('daterangepicker').setStartDate(moment());

            // Initialize DataTable
            dashboardDataTable = dashboardTableEl.DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
                columns: [
                    {
                        data: 'teacherPhotoUrl', orderable: false, searchable: false, // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1: ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π
                        render: function(data, type, row) {
                            // Teacher Profile Photo with zoom/alert
                            const imgSrc = data || DEFAULT_PROFILE_IMG;
                            return `<img src="${imgSrc}" class="table-img dashboard-table-img" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" onerror="this.onerror=null; this.src='${DEFAULT_PROFILE_IMG}';" data-img-src="${imgSrc}">`;
                        }
                    },
                    { data: 'teacherName' }, // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 2: ‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•
                    { data: 'level', defaultContent: 'N/A' }, // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 3: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
                    { data: 'dutyType' }, // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 4: ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    {
                        data: 'timestamp', // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 5: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        render: function(data) {
                            return formatThaiDateTimeCustom(data); // Use the new custom format
                        }
                    }
                ],
                order: [[4, 'desc']], // Default sort by timestamp descending (column index 4)
                responsive: true,
                pageLength: 10,
                lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] ],
                 dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                      '<"row dt-row"<"col-sm-12"tr>>' +
                      '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                 drawCallback: function(settings) { // Add drawCallback for event listeners
                     addDashboardImageEventListeners(); // Attach listeners after draw
                 }
            });

            // Event listeners for filters
            dashboardDutyFilterEl.addEventListener('change', filterDashboardTable); // Filter client-side
            dashboardLevelFilterEl.addEventListener('change', filterDashboardTable); // New Level Filter
            refreshDashboardBtn.addEventListener('click', loadDashboardData);

             // Initial data load handled by switchPage
        }

        async function loadDashboardData() {
            if (!dashboardPage.classList.contains('active')) return; // Don't load if page not visible
            if (SCRIPT_URL.includes('YOUR_SCRIPT_URL')) return;

            showLoading(true);
            const selectedDate = $(dashboardDateFilterEl).data('daterangepicker').startDate.format('YYYY-MM-DD');
            dashboardTableDateEl.textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(selectedDate)}`; // Update date display

            const url = `${SCRIPT_URL}?action=getDashboardData&date=${selectedDate}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Server error (${response.status}): ${response.statusText}`);
                 const data = await response.json();
                 console.log("Dashboard Data Received:", data);

                 if (data.status === 'success') {
                     updateDashboardCards(data.counts);
                     dashboardDataCache = data.recentLogs || []; // Store data
                     populateLevelFilter(dashboardLevelFilterEl, dashboardDataCache); // Populate level filter based on data
                     filterDashboardTable(); // Display and filter initial data
                 } else {
                     throw new Error(data.message || 'Failed to load dashboard data');
                 }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showSweetAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard ‡πÑ‡∏î‡πâ: ${error.message}`, false);
                if (dashboardDataTable) dashboardDataTable.clear().draw();
                updateDashboardCards(null); // Clear cards
                 dashboardDataCache = [];
                 dashboardTableDateEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
            } finally {
                showLoading(false);
            }
        }

         function updateDashboardCards(counts) {
             if (counts) {
                 loggedTodayCountEl.textContent = `${counts.loggedToday || 0} / ${counts.totalTeachers || 0}`;
                 gateDutyCountEl.textContent = `${counts.gateDutyLogged || 0}`;
                 buildingDutyCountEl.textContent = `${counts.buildingDutyLogged || 0}`;
             } else {
                loggedTodayCountEl.textContent = '0 / 0';
                gateDutyCountEl.textContent = '0';
                buildingDutyCountEl.textContent = '0';
             }
        }

         function populateLevelFilter(selectElement, data) {
             if (!selectElement || !data) return;
             const existingLevels = new Set();
             data.forEach(item => {
                 if (item.level && item.level !== 'N/A') {
                    existingLevels.add(item.level);
                 }
             });

             // Clear existing options except the 'all' option
             $(selectElement).find('option:not([value="all"])').remove();

             // Add options from the data
             existingLevels.forEach(level => {
                 $(selectElement).append($('<option>', {
                    value: level,
                    text: level
                 }));
             });
         }

         function filterDashboardTable() {
            if (!dashboardDataTable || dashboardDataCache === null) return;

            const selectedDuty = dashboardDutyFilterEl.value;
            const selectedLevel = dashboardLevelFilterEl.value; // Get selected level
            let filteredData = dashboardDataCache;

            // Filter by Level
            if (selectedLevel !== 'all') {
                 filteredData = filteredData.filter(log => log.level === selectedLevel);
            }

            // Filter by Duty/Status
            if (selectedDuty !== 'all') {
                 filteredData = filteredData.filter(log => log.dutyType === selectedDuty);
            }

            console.log(`Filtering dashboard. Level: ${selectedLevel}, Duty: ${selectedDuty}. Displaying ${filteredData.length} of ${dashboardDataCache.length} logs.`);

            dashboardDataTable.clear();
            dashboardDataTable.rows.add(filteredData);
            dashboardDataTable.draw();
         }

         // Function to handle image clicks in Dashboard Table
        function addDashboardImageEventListeners() {
             $('#dashboardTable tbody').off('click', 'img.dashboard-table-img').on('click', 'img.dashboard-table-img', function() {
                const src = $(this).data('img-src');
                 if (src && src !== DEFAULT_PROFILE_IMG) {
                    Swal.fire({
                        imageUrl: src, imageHeight: 400, imageAlt: '‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π',
                        showConfirmButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î'
                    });
                 } else {
                    // Optional: show message if placeholder clicked
                    // showSweetAlert('info', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ');
                 }
            });
        }


        // --- Check-in Form Functions ---

       function initializeCheckinFormLogic() {
             // Teacher ID Input Listener
             if (teacherIdInput) {
                 teacherIdInput.addEventListener('input', handleTeacherIdInput);
                 teacherIdInput.addEventListener('paste', (e) => { setTimeout(handleTeacherIdInput, 0); });
             } else { console.error("Checkin Element Missing: teacherIdInput"); }

             // Duty Status Change Listener (Event Delegation on Parent Section)
             if (dutyStatusSection) {
                  dutyStatusSection.addEventListener('change', handleDutyStatusChange);
             } else { console.error("Checkin Element Missing: dutyStatusSection"); }

             // Button Listeners
             if(getLocationBtn) getLocationBtn.addEventListener('click', initializeGeolocation); else console.warn("Checkin Element Missing: getLocationBtn");
             if(startCameraBtn) startCameraBtn.addEventListener('click', startCamera); else console.warn("Checkin Element Missing: startCameraBtn");
             if(capturePhotoBtn) capturePhotoBtn.addEventListener('click', capturePhoto); else console.warn("Checkin Element Missing: capturePhotoBtn");
             if(resetPhotoBtn) resetPhotoBtn.addEventListener('click', resetPhoto); else console.warn("Checkin Element Missing: resetPhotoBtn");

             // Form Submit Listener
             if (checkinForm) {
                 checkinForm.addEventListener('submit', handleCheckinFormSubmit);
             } else { console.error("Checkin Element Missing: checkinForm"); }

            addCompletionCheckListeners();
            hideAllCheckinSections(); // Ensure clean state on load
        }

        function initializeClock() {
            // Update clocks immediately on load, interval handles subsequent updates
             updateClockAndButtonState();
        }

        function isWithinWindow(currentTimeStr, startTimeStr, endTimeStr) {
            // Handles time comparison correctly even across midnight if needed (though unlikely here)
            return currentTimeStr >= startTimeStr && currentTimeStr <= endTimeStr;
        }

        function updateClockAndButtonState() {
            // Update Clock Display (only if relevant page is active)
            const now = new Date();
             const year = now.getFullYear() + 543;
             const optsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
             const optsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
             const thaiDate = now.toLocaleDateString('th-TH', optsDate).replace(String(now.getFullYear()), String(year));
             const thaiTime = now.toLocaleTimeString('th-TH', optsTime);
             const clockText = `<i class="fas fa-clock me-2"></i> ${thaiDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${thaiTime} ‡∏ô.`;

             if(homePage.classList.contains('active') && clockElementHome) clockElementHome.innerHTML = clockText;
             if(checkinPage.classList.contains('active') && clockElementCheckin) clockElementCheckin.innerHTML = clockText;


            if (isSubmitting || !checkinPage.classList.contains('active')) {
                 // Don't update check-in button state if submitting or check-in page not active
                 return;
             }

            // Check Check-in Time Window
            const currentTimeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }); // Use HH:mm format
            checkinAllowed = false; currentCheckinWindow = null;
            if (isWithinWindow(currentTimeStr, MORNING_START_TIME, MORNING_END_TIME)) { checkinAllowed = true; currentCheckinWindow = 'morning'; }
            else if (isWithinWindow(currentTimeStr, AFTERNOON_START_TIME, AFTERNOON_END_TIME)) { checkinAllowed = true; currentCheckinWindow = 'afternoon'; }

            // Update Submit button text and state (only if check-in page active)
            updateSubmitButtonDisplay();
        }

        function handleTeacherIdInput() {
             const currentVal = teacherIdInput.value.replace(/\D/g,''); // Remove non-digits
             teacherIdInput.value = currentVal; // Update input field
             teacherLookupStatus.textContent = '';
             teacherLookupStatus.classList.remove('text-danger', 'text-success');

             if (currentVal.length === 4) {
                 showLoadingAndFetchTeacher(currentVal);
             } else if (currentVal.length > 0) {
                  teacherLookupStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 4 ‡∏ï‡∏±‡∏ß';
                  hideAllCheckinSections(false); // Hide below teacher info
             } else {
                  hideAllCheckinSections(true); // Hide everything
             }
        }

         function showLoadingAndFetchTeacher(teacherId) {
            teacherLookupStatus.textContent = '';
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π...', text: `‡∏£‡∏´‡∏±‡∏™: ${teacherId}`,
                allowOutsideClick: false, allowEscapeKey: false,
                didOpen: () => { Swal.showLoading(); }
            });
             hideAllCheckinSections(false); // Keep ID, hide below
            fetchTeacherData(teacherId);
        }

        async function fetchTeacherData(teacherId) {
            if (!teacherId || SCRIPT_URL.includes('YOUR_SCRIPT_URL')) {
                // Swal.close(); // Already handled by finally block below
                if (SCRIPT_URL.includes('YOUR_SCRIPT_URL')) {
                     showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set', false);
                }
                return;
            }
            teacherDataCache = null; // Reset cache

            // Show loading SweetAlert (moved from showLoadingAndFetchTeacher)
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π...', text: `‡∏£‡∏´‡∏±‡∏™: ${teacherId}`,
                allowOutsideClick: false, allowEscapeKey: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // showLoading(true); // Loading is handled by Swal now
                const lookupUrl = `${SCRIPT_URL}?action=getTeacherInfo&id=${encodeURIComponent(teacherId)}`;
                const response = await fetch(lookupUrl);

                if (!response.ok) throw new Error(`Server Connection Error (${response.status})`);
                const data = await response.json(); // Assume server sends JSON
                 console.log("Teacher Info Received:", data);

                if (data.error) throw new Error(data.error);
                 // *** Check for 'not found' FIRST ***
                 if (!data.found || !data.teacher) {
                     // Throw an error to be caught by the catch block, which shows the error SweetAlert
                     throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <a style="color:#0515f5;cursor:pointer" target="_blank" href="https://line.me/ti/p/3F7VGrqgUr">‡∏≠.‡∏ò‡∏ô‡∏™‡∏≤‡∏£ ‡∏™‡∏µ‡∏£‡∏±‡∏Å‡∏©‡πå</a>');
                 }

                // *** Success Path - Close loading Swal and show Success Swal ***
                if (Swal.isLoading()) { Swal.close(); } // Close loading alert first
                 Swal.fire({
                    icon: 'success',
                    title: '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    html: `<strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> ${data.teacher.name || 'N/A'}`,
                    timer: 2000, // Shorter timer for success
                    timerProgressBar: true,
                    showConfirmButton: false // No need for confirm button
                });

                // Populate UI (as before)
                teacherDataCache = data.teacher;
                teacherNameSpan.textContent = data.teacher.name || 'N/A';
                teacherDepartmentSpan.textContent = data.teacher.department || 'N/A';
                teacherPositionSpan.textContent = data.teacher.position || 'N/A';
                teacherPhoto.src = data.teacher.photoUrl || PLACEHOLDER_IMG; // Profile photo
                teacherPhoto.onerror = () => { teacherPhoto.src = PLACEHOLDER_IMG; };
                hiddenTeacherName.value = data.teacher.name || '';
                hiddenTeacherDepartment.value = data.teacher.department || '';

                teacherLookupStatus.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${data.teacher.name || 'N/A'}`;
                teacherLookupStatus.classList.remove('text-danger');
                 teacherLookupStatus.classList.add('text-success');
                showBaseInfoAndDutyStatus(); // Show next section

            } catch (error) {
                 // *** Error Path (Includes 'Not Found' from the throw above) ***
                 console.error('Fetch Teacher Error:', error);
                 if (Swal.isLoading()) { Swal.close(); } // Close loading alert if still open

                 teacherLookupStatus.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`; // Show error near input
                 teacherLookupStatus.classList.add('text-danger');
                 teacherLookupStatus.classList.remove('text-success');
                 hideAllCheckinSections(false); // Hide sections below ID
                 teacherIdInput.focus();
                 teacherDataCache = null;

                 // Show error SweetAlert (this now handles 'not found' as well)
                 showSweetAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`, false);

             } finally {
                 // showLoading(false); // Loading handled by Swal
                 // Ensure Swal is closed if something unexpected happened
                 if (Swal.isLoading()) { Swal.close(); }
             }
        }

        // You might need to REMOVE the Swal call from showLoadingAndFetchTeacher
        // as it's now handled within fetchTeacherData itself.
        function showLoadingAndFetchTeacher(teacherId) {
            teacherLookupStatus.textContent = '';
            /* REMOVED Swal.fire CALL FROM HERE
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π...', text: `‡∏£‡∏´‡∏±‡∏™: ${teacherId}`,
                allowOutsideClick: false, allowEscapeKey: false,
                didOpen: () => { Swal.showLoading(); }
            });
            */
            hideAllCheckinSections(false); // Keep ID, hide below
            fetchTeacherData(teacherId); // Call the modified fetchTeacherData
        }

        function showBaseInfoAndDutyStatus() {
             teacherInfoDiv.style.display = 'block';
             dutyStatusSection.style.display = 'block';
             dutyStatusRadios.forEach(radio => radio.checked = false);
             hideDutySubSections(); // Hide sections below duty status initially
             checkFormCompletion();
        }

        function hideAllCheckinSections(clearTeacherId = true) {
            // console.log(`Hiding checkin sections, clearTeacherId=${clearTeacherId}`);
            teacherInfoDiv.style.display = 'none';
            dutyStatusSection.style.display = 'none';
             hideDutySubSections(); // Hides type, remarks, location, sig, photo, submit

            if (teacherDataCache) { teacherDataCache = null; }
            hiddenTeacherName.value = ''; hiddenTeacherDepartment.value = '';
            locationAcquired = false;

            if (clearTeacherId) {
                teacherIdInput.value = '';
                teacherLookupStatus.textContent = '';
                teacherLookupStatus.classList.remove('text-danger', 'text-success');
            }

             clearValidationErrors();
             statusMessage.innerHTML = '';
             stopCameraStream(); // Stop camera if running
             if (signaturePad) signaturePad.clear();
             signatureDataInput.value = '';
             photoDataInput.value = ''; // Clear hidden base64 photo data
             capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
             startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
             startCameraBtn.disabled = false; // Re-enable start camera button
             capturePhotoBtn.disabled = true;
             resetPhotoBtn.disabled = true;
             cameraErrorDiv.textContent = ''; photoErrorDiv.textContent = '';
             latitudeInput.value = ''; longitudeInput.value = '';
             locationInfoDiv.querySelector('span').textContent = ''; // Clear location text
             locationErrorDiv.textContent = '';
             const mapLink = locationInfoDiv.querySelector('a.map-link'); if(mapLink) mapLink.remove();

             checkFormCompletion(); // Update submit button state (should be hidden/disabled)
        }

         function hideDutySubSections() {
            dutyTypeSection.style.display = 'none';
            remarksSection.style.display = 'none';
            locationSection.style.display = 'none';
            signatureSection.style.display = 'none';
            photoSection.style.display = 'none';
            submitButtonSection.style.display = 'none';
            // Reset dependent fields when hiding sections
            dutyTypeRadios.forEach(r => r.checked = false);
            remarksInput.value = '';
        }

        async function handleDutyStatusChange(event) {
            // Check if the event target is one of the radio buttons we care about
             if (!event.target || event.target.name !== 'dutyStatus') return;

            const selectedStatus = event.target.value;
            console.log("Duty status changed to:", selectedStatus);

            clearValidationErrors(['dutyStatusError']); // Clear only duty status error initially
            dutySubSectionsLoading.style.display = 'flex'; // Show spinner
            hideDutySubSections(); // Hide everything below first

            // Reset fields that depend on status before showing new sections
            dutyTypeRadios.forEach(r => { r.checked = false; r.required = false; });
            remarksInput.value = ''; remarksInput.required = false;
            locationAcquired = false; latitudeInput.value = ''; longitudeInput.value = ''; locationErrorDiv.textContent = '';
            locationInfoDiv.querySelector('span').textContent = '';
             const mapLinkOld = locationInfoDiv.querySelector('a.map-link'); if (mapLinkOld) mapLinkOld.remove();
            if (signaturePad) signaturePad.clear(); signatureDataInput.value = ''; signatureErrorDiv.textContent = '';
            photoDataInput.value = ''; photoErrorDiv.textContent = ''; capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
            startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á'; capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true; cameraErrorDiv.textContent = '';
            startCameraBtn.disabled = false; // Re-enable start camera button
            stopCameraStream(); // Stop camera if running
             // --- End Reset fields ---

            await new Promise(resolve => setTimeout(resolve, 50)); // Short delay for UI update

            if (selectedStatus === '‡∏°‡∏≤') {
                dutyTypeSection.style.display = 'block';
                locationSection.style.display = 'block';
                signatureSection.style.display = 'block';
                photoSection.style.display = 'block';
                submitButtonSection.style.display = 'grid'; // Use grid for d-grid
                dutyTypeRadios.forEach(r => r.required = true);
                remarksInput.required = false;
                initializeGeolocation(); // Start getting location
                resizeCanvas(); // Ensure signature pad is sized correctly
            } else if (selectedStatus === '‡∏•‡∏≤' || selectedStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
                remarksSection.style.display = 'block';
                submitButtonSection.style.display = 'grid'; // Use grid for d-grid
                remarksInput.required = true;
                dutyTypeRadios.forEach(r => r.required = false);
            } else {
                 // Should not happen if a radio is selected, but hide submit just in case
                 submitButtonSection.style.display = 'none';
            }

            dutySubSectionsLoading.style.display = 'none'; // Hide spinner
            checkFormCompletion(); // Update submit button state after showing/hiding sections
        }

        // Geolocation Functions
         function initializeGeolocation() {
             if (!locationSection || locationSection.style.display === 'none') return;
             locationInfoDiv.querySelector('span').innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
             locationErrorDiv.textContent = ''; latitudeInput.value = ''; longitudeInput.value = '';
             locationAcquired = false;
             clearValidationErrors(['locationError']);
             checkFormCompletion(); // Update button state

             if ('geolocation' in navigator) {
                 if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                 navigator.geolocation.getCurrentPosition(
                     (pos) => {
                         latitudeInput.value = pos.coords.latitude.toFixed(8);
                         longitudeInput.value = pos.coords.longitude.toFixed(8);
                         locationAcquired = true;
                         locationInfoDiv.querySelector('span').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                          // Add/Update map link
                          const mapLinkUrl = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                          let link = locationInfoDiv.querySelector('a.map-link');
                          if (!link) {
                              link = document.createElement('a');
                              link.target = '_blank'; link.rel = 'noopener noreferrer';
                              link.classList.add('ms-1', 'small', 'map-link', 'text-decoration-none');
                              link.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                              link.title = '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
                              locationInfoDiv.appendChild(link); // Append after span
                          }
                          link.href = mapLinkUrl;
                         checkFormCompletion(); // Re-check completion after getting location
                     },
                     (err) => {
                         handleLocationError(err);
                         locationAcquired = false;
                         checkFormCompletion();
                     },
                     { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                 );
             } else {
                 handleLocationError({ code: -1, message: 'Geolocation ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ' });
                 locationAcquired = false;
                 checkFormCompletion();
             }
         }

         function handleLocationError(error) {
             console.error('Geolocation Error:', error);
             let msg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ';
             switch (error.code) {
                 case error.PERMISSION_DENIED: msg += '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'; break;
                 case error.POSITION_UNAVAILABLE: msg += '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ'; break;
                 case error.TIMEOUT: msg += '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'; break;
                 case -1: msg = error.message; break; // Custom message
                 default: msg += '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'; break;
             }
             locationInfoDiv.querySelector('span').innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i> ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
             locationErrorDiv.textContent = msg;
             latitudeInput.value = ''; longitudeInput.value = '';
             const mapLink = locationInfoDiv.querySelector('a.map-link'); if(mapLink) mapLink.remove();
         }

        // Signature Pad Functions
         function initializeSignaturePad() {
              setTimeout(() => {
                 if (!signatureCanvas) { console.error("Signature canvas element not found."); return; }
                 resizeCanvas(); // Initial size calculation
                 signaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });

                 if (resetSignatureBtn) {
                     resetSignatureBtn.addEventListener('click', () => {
                         if(signaturePad) signaturePad.clear();
                         signatureDataInput.value = '';
                         clearValidationErrors(['signatureError']);
                         checkFormCompletion();
                     });
                 } else { console.warn("Reset signature button not found."); }

                 // Clear error message when user starts drawing
                 signatureCanvas.addEventListener('pointerdown', () => {
                      if(signaturePad && !signaturePad.isEmpty()) { clearValidationErrors(['signatureError']); }
                 });

                 // Update hidden input when drawing stops
                 signaturePad.addEventListener("endStroke", () => {
                     if (signaturePad) {
                         signatureDataInput.value = signaturePad.isEmpty() ? '' : signaturePad.toDataURL('image/jpeg', 0.8).split(',')[1]; // Store base64 only
                         checkFormCompletion(); // Check if form is now complete
                         if(!signaturePad.isEmpty()) clearValidationErrors(['signatureError']); // Clear error if signature exists
                     }
                 });
              }, 100); // Delay slightly to ensure layout is stable
         }

         function resizeCanvas() {
            if (!signatureCanvas || !signatureCanvas.offsetParent) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const container = signatureCanvas.parentElement;
             // Check if container is valid and has dimensions
             if (!container || container.offsetWidth === 0 || container.offsetHeight === 0) {
                 // console.warn("Signature container not ready for resize.");
                 return;
             }
            signatureCanvas.width = container.offsetWidth * ratio;
            signatureCanvas.height = container.offsetHeight * ratio;
            signatureCanvas.style.width = `${container.offsetWidth}px`;
            signatureCanvas.style.height = `${container.offsetHeight}px`;
            const ctx = signatureCanvas.getContext("2d");
             if (ctx) {
                ctx.scale(ratio, ratio);
                 if (signaturePad) {
                    // Redraw existing signature data after resize
                    const data = signaturePad.toData(); // Backup data
                    signaturePad.clear(); // Clear current canvas
                    signaturePad.fromData(data); // Redraw backed up data
                 }
             }
        }

        // Camera Functions
        function stopCameraStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop()); stream = null;
                if (videoFeed) {
                    videoFeed.srcObject = null;
                    videoFeed.style.display = 'none'; // Hide video element
                    videoFeed.load(); // Attempt to free resources
                 }
                console.log("Camera stopped.");
            }
        }

        async function startCamera() {
            if (!photoSection || photoSection.style.display === 'none') return;
            cameraErrorDiv.textContent = ''; photoErrorDiv.textContent = '';
            clearValidationErrors(['cameraError', 'photoError']);
            stopCameraStream(); // Stop previous stream first
            await new Promise(resolve => setTimeout(resolve, 100)); // Short delay

            startCameraBtn.disabled = true; // Disable button while starting
            startCameraBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î...';

            try {
                 // Prefer front camera ('user')
                 const constraints = { video: { facingMode: 'user' }, audio: false };
                 stream = await navigator.mediaDevices.getUserMedia(constraints);

                 if (videoFeed) {
                     videoFeed.srcObject = stream;
                     videoFeed.style.display = 'block'; // Show video element
                     await videoFeed.play(); // Ensure video starts playing

                     capturePhotoBtn.disabled = false; resetPhotoBtn.disabled = true;
                     startCameraBtn.innerHTML = '<i class="fas fa-sync me-1"></i> ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                     checkFormCompletion();
                 }
                 if (capturedPhotoPreview) capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
                 if (photoDataInput) photoDataInput.value = '';

            } catch (err) {
                console.error("Camera Access Error:", err);
                let msg = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${err.name})`;
                if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") msg = "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á";
                else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") msg = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á";
                 else if (err.name === "NotReadableError" || err.name === "TrackStartError") msg = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
                 else if (err.name === "OverconstrainedError" || err.name === "ConstraintNotSatisfiedError") msg = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤";
                 else if (err.name === "AbortError") msg = "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";
                cameraErrorDiv.textContent = msg;
                capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true;
                startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                 if (videoFeed) videoFeed.style.display = 'none';
                stopCameraStream();
                checkFormCompletion();
             } finally {
                 startCameraBtn.disabled = false; // Re-enable button regardless of outcome
             }
         }

         function capturePhoto() {
             if (!stream || !stream.active || !videoFeed || videoFeed.readyState < videoFeed.HAVE_METADATA) {
                 cameraErrorDiv.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô';
                 return;
              }
             clearValidationErrors(['photoError']);

             const videoWidth = videoFeed.videoWidth; const videoHeight = videoFeed.videoHeight;
             if (!videoWidth || !videoHeight) { cameraErrorDiv.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠'; return; }

             if (photoCanvas) {
                 photoCanvas.width = videoWidth; photoCanvas.height = videoHeight;
                 const ctx = photoCanvas.getContext('2d');
                 // Flip image horizontally if using front camera (user facing)
                 if (stream.getVideoTracks()[0]?.getSettings()?.facingMode === 'user') {
                      ctx.translate(videoWidth, 0);
                      ctx.scale(-1, 1);
                 }
                 ctx.drawImage(videoFeed, 0, 0, videoWidth, videoHeight);
                 const dataUrl = photoCanvas.toDataURL('image/jpeg', 0.8); // Use JPEG, quality 0.8
                 if (capturedPhotoPreview) capturedPhotoPreview.src = dataUrl;
                 if (photoDataInput) photoDataInput.value = dataUrl.split(',')[1]; // Store base64 only
             }

             resetPhotoBtn.disabled = false; // Enable reset
             capturePhotoBtn.disabled = true; // Disable capture after taking one
             checkFormCompletion(); // Check if form is now complete
             clearValidationErrors(['photoError']); // Clear error if photo taken
        }

         function resetPhoto() {
             clearValidationErrors(['photoError']);
             if (photoDataInput) photoDataInput.value = '';
             if (capturedPhotoPreview) capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
             resetPhotoBtn.disabled = true; // Disable reset
             if (stream && stream.active) { capturePhotoBtn.disabled = false; } // Re-enable capture if camera active
             else { capturePhotoBtn.disabled = true; }
             checkFormCompletion();
        }


        // Form Completion & Validation
        function addCompletionCheckListeners() {
             // Listen to changes on visible inputs that affect completion
             dutyTypeRadios.forEach(r => r.addEventListener('change', checkFormCompletion));
             remarksInput.addEventListener('input', checkFormCompletion);
             // Completion for location, signature, photo is checked implicitly when they are updated/acquired
             // Teacher ID input already triggers checks
             dutyStatusRadios.forEach(r => r.addEventListener('change', checkFormCompletion)); // Ensure status change triggers check
        }

        function checkFormCompletion() {
            const selectedStatusRadio = document.querySelector('input[name="dutyStatus"]:checked');
            const selectedStatus = selectedStatusRadio ? selectedStatusRadio.value : null;
            let isComplete = false;

            if (!teacherDataCache || !selectedStatus) {
                isComplete = false;
            } else if (selectedStatus === '‡∏°‡∏≤') {
                const dutyTypeSelected = document.querySelector('input[name="dutyType"]:checked');
                const signatureDone = signaturePad && !signaturePad.isEmpty() && signatureDataInput.value;
                const photoTaken = photoDataInput.value;
                const locationDone = latitudeInput.value && longitudeInput.value && locationAcquired;
                isComplete = !!(dutyTypeSelected && locationDone && signatureDone && photoTaken);
                // Debug log
                // console.log(`Check '‡∏°‡∏≤': Type=${!!dutyTypeSelected}, Loc=${locationDone}, Sig=${!!signatureDone}, Pho=${!!photoTaken} -> Complete=${isComplete}`);
            } else if (selectedStatus === '‡∏•‡∏≤' || selectedStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
                const remarksFilled = remarksInput.value.trim() !== '';
                isComplete = remarksFilled;
                 // console.log(`Check '‡∏•‡∏≤'/'‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£': Remarks=${remarksFilled} -> Complete=${isComplete}`);
            }

            // console.log(`Overall Completion Check: Status=${selectedStatus}, Cache=${!!teacherDataCache}, Complete=${isComplete}`);
            updateSubmitButtonDisplay(isComplete); // Update button based on completion
            return isComplete;
        }

        function updateSubmitButtonDisplay(isFormComplete = checkFormCompletion()) {
             // Check if the button's section is visible first
             const isSectionVisible = submitButtonSection && submitButtonSection.style.display !== 'none';

            if (!isSectionVisible) {
                 // If section is hidden, ensure button is disabled and has default text
                 submitBtn.disabled = true;
                 submitBtn.classList.replace('btn-primary','btn-secondary');
                 submitBtn.innerHTML = `<i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö`;
                 return;
             }

             // Section is visible, now check time and completion
             if (checkinAllowed && isFormComplete) {
                 submitBtn.disabled = false;
                 submitBtn.classList.replace('btn-secondary','btn-primary'); // Use primary color for active button
                 const windowText = currentCheckinWindow === 'morning' ? '‡πÄ‡∏ä‡πâ‡∏≤' : (currentCheckinWindow === 'afternoon' ? '‡∏ö‡πà‡∏≤‡∏¢' : '');
                 submitBtn.innerHTML = `<i class="fas fa-paper-plane me-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${windowText ? '(‡∏£‡∏≠‡∏ö' + windowText + ')' : ''}`;
             } else {
                 submitBtn.disabled = true;
                 submitBtn.classList.replace('btn-primary','btn-secondary'); // Use secondary color for inactive button
                 if (!isFormComplete) {
                     submitBtn.innerHTML = `<i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö`;
                 } else { // Complete but outside window
                     submitBtn.innerHTML = `<i class="fas fa-clock me-2"></i> ‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ (${MORNING_START_TIME}-${MORNING_END_TIME} ‡∏´‡∏£‡∏∑‡∏≠ ${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME})`;
                 }
             }
         }

         function validateForm() {
             clearValidationErrors(); // Clear previous
             let isValid = true;
             const selectedStatusRadio = document.querySelector('input[name="dutyStatus"]:checked');
             const statusValue = selectedStatusRadio ? selectedStatusRadio.value : null;

             if (!teacherDataCache) { showSweetAlert('warning', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); isValid = false; teacherIdInput.focus(); }
             else if (!statusValue) { dutyStatusErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'; isValid = false; dutyStatusSection.scrollIntoView({ behavior: 'smooth', block: 'center' });}
             else if (statusValue === '‡∏°‡∏≤') {
                 if (!document.querySelector('input[name="dutyType"]:checked')) { dutyTypeErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'; isValid = false; if(isValid) dutyTypeSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  if (!latitudeInput.value || !longitudeInput.value || !locationAcquired) { locationErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏Å‡∏î <i class="fas fa-sync"></i> ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)'; isValid = false; if(isValid) locationSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  if (signaturePad.isEmpty() || !signatureDataInput.value) { signatureErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠'; isValid = false; if(isValid) signatureSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  if (!photoDataInput.value) { photoErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'; isValid = false; if(isValid) photoSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
             } else if ((statusValue === '‡∏•‡∏≤' || statusValue === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£')) {
                 if (!remarksInput.value.trim()) { remarksErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)'; isValid = false; if(isValid) remarksSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
             }

             // Final time check
             if (isValid && !checkinAllowed) {
                  showSweetAlert('warning', '‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', `‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤ (${MORNING_START_TIME}-${MORNING_END_TIME} ‡∏ô.) ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢ (${AFTERNOON_START_TIME}-${AFTERNOON_END_TIME} ‡∏ô.) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`); isValid = false;
             }

             // Scroll to first error (handled inside checks now)
             // if (!isValid) {
             //      const firstError = checkinForm.querySelector('.form-text.text-danger:not(:empty), .invalid-feedback:not(:empty)');
             //      firstError?.closest('.form-section, .mb-3')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
             // }
             return isValid;
         }

         function clearValidationErrors(exceptIds = []) {
             const errorDivs = checkinForm.querySelectorAll('.form-text.text-danger, .invalid-feedback');
             errorDivs.forEach(div => { if (!exceptIds.includes(div.id)) { div.textContent = ''; } });
         }


        // Form Submission Handler
        async function handleCheckinFormSubmit(event) {
            event.preventDefault();
             if (isSubmitting) return;
            if (!validateForm()) return;
             if (SCRIPT_URL.includes('YOUR_SCRIPT_URL')) { showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set', false); return; }

            // Confirmation
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                html: `‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${teacherDataCache?.name || 'N/A'}<br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${document.querySelector('input[name="dutyStatus"]:checked')?.value || 'N/A'}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
                confirmButtonText: ' <i class="fas fa-check"></i> ‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ', cancelButtonText: '<i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    isSubmitting = true; statusMessage.innerHTML = ''; submitBtn.disabled = true;
                    const formData = new FormData(checkinForm);

                     // Ensure correct Base64 data for signature and photo (already base64 only)
                     if (formData.get('dutyStatus') === '‡∏°‡∏≤') {
                         // Keep signatureData and photoData as they are (should be base64 only)
                         formData.delete('remarks'); // Remove remarks if '‡∏°‡∏≤'
                     } else {
                          // Clear fields not relevant for '‡∏•‡∏≤'/'‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£'
                          formData.delete('dutyType'); formData.delete('latitude'); formData.delete('longitude');
                          formData.delete('signatureData'); formData.delete('photoData');
                     }
                    formData.append('clientTimestamp', new Date().toISOString());

                     let fetchSuccess = false; let successData = null; let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';

                    try {
                        console.log("Submitting Form Data:", Object.fromEntries(formData.entries())); // Log before sending (excluding large base64)
                        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                        const fetchResult = await response.json(); // Assume JSON response
                         console.log("Server Response (POST):", fetchResult);

                        if (fetchResult.status === 'success') {
                             fetchSuccess = true;
                             const now = new Date(); const thaiDateTime = formatThaiDateTimeCustom(now); // Use custom format
                             // Prepare photo URL for success message (if '‡∏°‡∏≤')
                             const photoBase64 = formData.get('dutyStatus') === '‡∏°‡∏≤' ? formData.get('photoData') : null;
                             const photoDataUrl = photoBase64 ? `data:image/jpeg;base64,${photoBase64}` : null;
                             successData = { thaiDateTime, status: formData.get('dutyStatus'), photoDataUrl };
                        } else {
                             errorMessage = fetchResult.message || '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; throw new Error(errorMessage);
                         }
                    } catch (error) {
                        console.error('Submit Error:', error); errorMessage = error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
                    } finally {
                        if (Swal.isVisible() && Swal.isLoading()) Swal.close(); // Close loading Swal only if it exists
                        isSubmitting = false; submitBtn.disabled = false; // Re-enable button

                        if (fetchSuccess && successData) {
                            // Use custom success alert
                            showSuccessSweetAlert(successData.thaiDateTime, teacherDataCache?.name || 'N/A', successData.photoDataUrl);
                            resetCheckinForm(); // Reset form on success
                             // Optionally switch to dashboard after success?
                             // switchPage('dashboardPage');
                        } else {
                            showSweetAlert('error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMessage}`, false);
                            // *** Reset teacher ID input on failure ***
                            teacherIdInput.value = '';
                            hideAllCheckinSections(false); // Keep message, hide lower sections
                            teacherLookupStatus.textContent = `‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                            teacherLookupStatus.className = 'form-text mt-1 small text-danger';
                            teacherIdInput.focus();
                            // Don't reset the entire form, allow user to see previous input if needed, just clear ID
                            checkFormCompletion(); // Re-evaluate button state
                        }
                    } // End finally
                } // End if confirmed
            }); // End confirmation Swal
        }

        function resetCheckinForm() {
             console.log("Resetting Check-in Form after success");
             checkinForm.reset(); // Resets all standard form fields
             hideAllCheckinSections(true); // Also clears teacher ID, photo, sig, etc., and removes status message
             if (checkinPage.classList.contains('active')) { // Only scroll if check-in page is active
                  window.scrollTo({ top: 0, behavior: 'smooth' });
             }
             updateClockAndButtonState(); // Update button state
        }



        // --- Search Statistics Functions ---

        function initializeSearchStats() {
             // Initialize Date Range Picker for Stats
             $(statsDateFilterEl).daterangepicker({
                 autoUpdateInput: false, // Don't auto-update the input value
                 showDropdowns: true,
                 locale: {
                     format: 'DD/MM/YYYY', // Display format
                     separator: ' - ',
                     applyLabel: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', cancelLabel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                     fromLabel: '‡∏à‡∏≤‡∏Å', toLabel: '‡∏ñ‡∏∂‡∏á',
                     daysOfWeek: moment.weekdaysMin(), monthNames: moment.months(),
                     firstDay: moment.localeData('th').firstDayOfWeek()
                 },
                 ranges: { // Optional preset ranges
                    '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ': [moment(), moment()],
                    '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    '7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î': [moment().subtract(6, 'days'), moment()],
                    '30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î': [moment().subtract(29, 'days'), moment()],
                    '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ': [moment().startOf('month'), moment().endOf('month')],
                    '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                 }
             });

             // Handle apply event for daterangepicker
             $(statsDateFilterEl).on('apply.daterangepicker', function(ev, picker) {
                 $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
                 filterStatsTable(); // Apply filter
             });

             // Handle cancel event
             $(statsDateFilterEl).on('cancel.daterangepicker', function(ev, picker) {
                 $(this).val(''); // Clear input
                 filterStatsTable(); // Apply filter (show all dates)
             });


             // Initialize DataTable
             statsDataTable = statsTableEl.DataTable({
                 language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
                 columns: [
                     { // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1: ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                         data: 'checkinPhotoUrl', orderable: false, searchable: false,
                         render: function(data, type, row) {
                             // Check-in Photo with zoom/alert functionality
                             const imgSrc = data || CHECKIN_PHOTO_PLACEHOLDER;
                             return `<img src="${imgSrc}" class="table-img stats-table-img" alt="‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" onerror="this.onerror=null; this.src='${CHECKIN_PHOTO_PLACEHOLDER}';" data-img-src="${imgSrc}">`;
                         }
                     },
                     { data: 'level', defaultContent: 'N/A' }, // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 2: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
                     { data: 'dutyOrStatus' }, // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 3: ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                     { // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 4: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                         data: 'timestamp',
                         render: function(data) {
                             return formatThaiDateTimeCustom(data); // Use the new custom format
                         }
                     }
                 ],
                 order: [[3, 'desc']], // Default sort by timestamp descending (column index 3)
                 responsive: true,
                 pageLength: 10,
                 lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] ],
                  dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' + // Length + Filter Input
                       '<"row dt-row"<"col-sm-12"tr>>' + // Table
                       '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>', // Info + Pagination
                  drawCallback: function(settings) { // Add drawCallback for event listeners
                      addStatsImageEventListeners(); // Attach listeners after draw
                  }
             });

            // Event listeners
            if(searchStatsBtn) searchStatsBtn.addEventListener('click', handleSearchStats); else console.warn("Search Element Missing: searchStatsBtn");
            if(searchTeacherIdInput) searchTeacherIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { handleSearchStats(); } }); else console.warn("Search Element Missing: searchTeacherIdInput");

             // Stats Filter Listeners
             statsDutyFilterEl.addEventListener('change', filterStatsTable);
             resetStatsFilterBtn.addEventListener('click', resetStatsFilters);
         }

        async function handleSearchStats() {
            const teacherId = searchTeacherIdInput.value.trim();
            searchMessage.textContent = ''; // Clear previous messages
            searchResultArea.style.display = 'none'; // Hide previous results
            statsDataCache = null; // Clear previous data cache
            resetStatsFilters(); // Reset filters on new search

            if (!teacherId || teacherId.length !== 4 || !/^\d+$/.test(teacherId)) { // Check if 4 digits
                searchMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π 4 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)'; searchMessage.className = 'mt-2 small text-danger';
                // *** ADD SWEETALERT FOR INVALID INPUT ***
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π 4 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)',
                    timer: 3000,
                    timerProgressBar: true
                });
                return;
            }
             if (SCRIPT_URL.includes('YOUR_SCRIPT_URL')) { showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set', false); return; }

            searchMessage.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            searchMessage.className = 'mt-2 small text-muted';
             showLoading(true);

            try {
                 const url = `${SCRIPT_URL}?action=getTeacherStats&id=${encodeURIComponent(teacherId)}`;
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`Server error (${response.status}): ${response.statusText}`);
                 const data = await response.json();
                 console.log("Teacher Stats Received:", data);

                 if (data.status === 'success') {
                     statsDataCache = data.checkinHistory || []; // Store history data
                     displayTeacherStats(data.teacherInfo, statsDataCache); // Display info and initial table
                     searchMessage.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π: ${data.teacherInfo?.name || teacherId}`;
                     searchMessage.className = 'mt-2 small text-success';
                     // *** ADD SWEETALERT FOR SUCCESS ***
                     Swal.fire({
                         icon: 'success',
                         title: '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                         html: `‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π: <strong>${data.teacherInfo?.name || teacherId}</strong>`,
                         showConfirmButton: true,
						 timer: 5000,
                         timerProgressBar: true
                     });
                 } else if (data.status === 'notfound') {
                      searchMessage.textContent = data.message || `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏£‡∏´‡∏±‡∏™ ${teacherId}`;
                      searchMessage.className = 'mt-2 small text-warning';
                      searchResultArea.style.display = 'none';
                      if (statsDataTable) statsDataTable.clear().draw();
                      // *** ADD SWEETALERT FOR NOT FOUND ***
                      Swal.fire({
                          icon: 'warning',
                          title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                          text: data.message || `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ${teacherId}`,
						  showConfirmButton: true,
                          timer: 5000,
                          timerProgressBar: true
                      });
                 } else {
                     throw new Error(data.message || 'Failed to load teacher statistics');
                 }

            } catch (error) {
                 console.error('Error loading teacher stats:', error);
                 searchMessage.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                 searchMessage.className = 'mt-2 small text-danger';
                  searchResultArea.style.display = 'none';
                  if (statsDataTable) statsDataTable.clear().draw();
                 // *** ADD SWEETALERT FOR ERROR ***
                 Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ: ${error.message}`
                 });
            } finally {
                 showLoading(false);
            }
        }

         function displayTeacherStats(teacherInfo, history) {
            if (!teacherInfo || !searchResultArea) {
                if(searchResultArea) searchResultArea.style.display = 'none';
                 if(statsDataTable) statsDataTable.clear().draw();
                return;
             }

             // Populate teacher info card
             statsTeacherPhoto.src = teacherInfo.photoUrl || PLACEHOLDER_IMG; // Profile photo
             statsTeacherPhoto.onerror = () => { statsTeacherPhoto.src = PLACEHOLDER_IMG; };
             statsTeacherName.textContent = teacherInfo.name || 'N/A';
             statsTeacherDepartment.textContent = teacherInfo.department || 'N/A';
             statsTeacherLevel.textContent = `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô: ${teacherInfo.level || 'N/A'}`; // Display Level

             // Calculate and Populate Stats Cards
             let totalDaysSet = new Set();
             let presentCount = 0;
             let leaveCount = 0;
             let tripCount = 0;

             if (history && history.length > 0) {
                 history.forEach(log => {
                     // Count distinct days
                     const date = moment(log.timestamp).format('YYYY-MM-DD');
                     totalDaysSet.add(date);

                     // Count status occurrences
                     const status = log.dutyOrStatus || '';
                     if (status === '‡∏•‡∏≤') {
                         leaveCount++;
                     } else if (status === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
                         tripCount++;
                     } else if (status.includes('‡∏°‡∏≤') || status === '‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π' || status === '‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£') {
                         presentCount++; // Counts each '‡∏°‡∏≤' record
                     }
                 });
             }
             statsTotalDaysEl.textContent = totalDaysSet.size; // Total distinct days recorded
             statsPresentDaysEl.textContent = presentCount;
             statsLeaveDaysEl.textContent = leaveCount;
             statsTripDaysEl.textContent = tripCount;

             // Populate data table (initially unfiltered)
             if (statsDataTable) {
                 statsDataTable.clear();
                 statsDataTable.rows.add(history || []); // Add check-in history
                 statsDataTable.order([3, 'desc']).draw(); // Ensure sorted by date descending
             }

             searchResultArea.style.display = 'block'; // Show the results area
             filterStatsTable(); // Apply any default/existing filter values initially
        }

        // Function to handle image clicks in Stats Table
        function addStatsImageEventListeners() {
             $('#statsTable tbody').off('click', 'img.stats-table-img').on('click', 'img.stats-table-img', function() {
                const src = $(this).data('img-src');
                 if (src && src !== CHECKIN_PHOTO_PLACEHOLDER) {
                    Swal.fire({
                        imageUrl: src, imageHeight: 400, imageAlt: '‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                        showConfirmButton: true, confirmButtonText: '‡∏õ‡∏¥‡∏î'
                    });
                 } else {
                    // Optional: show message if placeholder clicked
                    // showSweetAlert('info', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ');
                 }
            });
        }

        // Function to filter Stats Table Data (Client-Side)
         function filterStatsTable() {
             if (!statsDataTable || statsDataCache === null) return;

             const selectedDuty = statsDutyFilterEl.value; // Get duty filter value
             const dateRange = $(statsDateFilterEl).data('daterangepicker');
             const startDate = dateRange && dateRange.startDate ? dateRange.startDate.startOf('day') : null;
             const endDate = dateRange && dateRange.endDate ? dateRange.endDate.endOf('day') : null;

             // Apply filters to the DataTable
             $.fn.dataTable.ext.search.push(
                 function(settings, data, dataIndex) {
                     // Duty/Status Filter
                     const dutyStatus = data[2] || ''; // Column index 2 for Duty/Status
                     if (selectedDuty && dutyStatus !== selectedDuty) {
                         // If duty is selected and doesn't match, filter out
                         // Handle '‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)' case - needs exact match or complex logic if matching parts
                          if (selectedDuty === '‡∏°‡∏≤ \\(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\\)' && dutyStatus !== '‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)') return false;
                          if (selectedDuty !== '‡∏°‡∏≤ \\(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\\)' && dutyStatus !== selectedDuty) return false;

                     }

                     // Date Filter
                     const timestamp = data[3] || ''; // Column index 3 for formatted Timestamp
                     const recordDate = moment(statsDataCache[dataIndex].timestamp); // Use original ISO timestamp from cache for reliable comparison

                     if (startDate && endDate && recordDate.isValid()) {
                         if (!recordDate.isBetween(startDate, endDate, undefined, '[]')) { // '[]' includes start and end dates
                             return false; // Filter out if outside the date range
                         }
                     }

                     return true; // Keep row if it passes all filters
                 }
             );

             statsDataTable.draw(); // Redraw the table with applied filters
             $.fn.dataTable.ext.search.pop(); // Remove the temporary filter function
         }

         // Function to reset Stats Filters
         function resetStatsFilters() {
            // Reset Date Picker
            $(statsDateFilterEl).val('');
            $(statsDateFilterEl).data('daterangepicker').setStartDate(moment()); // Reset internal dates if needed
            $(statsDateFilterEl).data('daterangepicker').setEndDate(moment());

             // Reset Duty Select
             statsDutyFilterEl.value = ""; // Set to empty value (for 'all')

             // Re-apply filters (which will now show all data)
             filterStatsTable();
         }

    </script>

<script language="javascript">
    function showTime(){



now = new Date();
var thday = new Array ("‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå",
"‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå");
var thmonth = new Array ("‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°",
"‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô",
"‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°");

// document.write("‡∏ß‡∏±‡∏ô" + thday[now.getDay()]+ "‡∏ó‡∏µ‡πà "+ now.getDate()+ " " +
// thmonth[now.getMonth()]+ " " + (0+now.getYear()+543));


    var date2 = new Date();
    var h = date2.getHours(); // 0 - 23
    var m = date2.getMinutes(); // 0 - 59
    var s = date2.getSeconds(); // 0 - 59
    var session = "‡∏ô.";
    
    if(h == 0){
        h = 24;
    }
    
    if(h > 24){
        h = h - 24;
        session = "‡∏ô.";
    }
    
    h = (h < 10) ? "0" + h : h;
    m = (m < 10) ? "0" + m : m;
    s = (s < 10) ? "0" + s : s;
    
    var time = " ‡∏ß‡∏±‡∏ô" + thday[now.getDay()]+ "‡∏ó‡∏µ‡πà "+ now.getDate()+ " " +
    thmonth[now.getMonth()]+ " " + "‡∏û.‡∏®."+ (now.getYear()+2443) +" ‡πÄ‡∏ß‡∏•‡∏≤  " +  h + ":" + m + ":" + s + " " + session;
    document.getElementById("MyClockDisplay").innerText = time;
    document.getElementById("MyClockDisplay").textContent = time;
    
    setTimeout(showTime, 1000);

}

showTime();

    </script>

<script>




</body>
</html>
