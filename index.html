<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC|Teacherattendance v1</title> <link rel="shortcut icon" type="image/png" href="https://img2.pic.in.th/pic/Pakchong_School-removebg-preview.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">


    <style>
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        .page-section { display: none; } /* Hide all sections initially */
        .page-section.active { display: block; } /* Show active section */
        #schoolBanner { max-height: 300px; width: 100%; object-fit: cover; margin-bottom: 0.2rem; } /* Banner style */
        #schoolLogo { max-height: 60px; width: auto; }
        #clock-home { font-size: 1.0rem; font-weight: bold; }
        #MyClockDisplay { font-size: 1.0rem; font-weight: bold;} /* For checkin page clock */
        .teacher-photo { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid #dee2e6; }
        .signature-pad-container { position: relative; width: 100%; height: 150px; background-color: #ffffff; cursor: crosshair; border: 1px solid #ced4da; border-radius: 0.375rem; }
        #signatureCanvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; border-radius: 0.375rem; }
        #videoFeed { width: 100%; height: auto; max-height: 200px; display: none; background-color: #343a40; } /* Hidden initially */
        .captured-photo { max-height: 200px; display: block; margin-left: auto; margin-right: auto; background-color: #e9ecef; }
        .form-label { margin-bottom: 0.5rem; font-weight: bold; }
        .btn-group-camera button { margin: 0 3px; }
        .card-title { margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: normal;} /* Adjusted card title size */
        .card-text { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.2rem;} /* Adjusted card text margin */
        .card-text-small { font-size: 0.75em; color: rgba(255, 255, 255, 0.8); } /* Smaller text for units */
        .loading-overlay {
            position: fixed; /* Changed to fixed for full page */
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.8); z-index: 1060; /* Higher z-index */
            display: none; /* Hidden by default */ align-items: center; justify-content: center;
        }
         .loading-overlay.active { display: flex; } /* Show when active */

        .table-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 5px; vertical-align: middle; transition: transform 0.2s ease-in-out; }
        .table-img:hover { transform: scale(1.5); } /* Simple hover zoom */
        .dashboard-table-img, .stats-table-img { cursor: pointer; } /* Add pointer cursor */
        #dashboardTable td, #statsTable td { vertical-align: middle; font-size: 0.9rem; } /* Adjust table font size */
        #dashboardTable th, #statsTable th { font-size: 0.9rem; }
        .small-text { font-size: 0.85em; }
        .teacher-profile-card { background-color: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .teacher-profile-card img { width: 80px; height: 80px; }

        /* DataTables specific adjustments */
        .dataTables_wrapper .row { margin-bottom: 0.5rem;}
         div.dataTables_wrapper div.dataTables_filter input { width: 150px; display: inline-block; margin-left: 0.5em;}
         div.dataTables_wrapper div.dataTables_length select { width: auto; display: inline-block; }
         div.dataTables_wrapper div.dataTables_info,
         div.dataTables_wrapper div.dataTables_paginate { padding-top: 0.5em; font-size: 0.85rem;}

        /* Footer style */
        .footer { background-color: #e9ecef; color: #6c757d; padding: 10px 0; font-size: 0.8em;}
        .footer a { color: #dc3545; text-decoration: none; }

         /* Navigation Buttons */
         .main-nav .btn { margin: 0 2px; }

        @media (max-width: 767.98px) {
            .teacher-photo { max-width: 200px; height: 100px; margin-bottom: 1rem; }
            #videoFeed, .captured-photo { max-width: 200px; max-height: 250px; }
            .signature-pad-container { height: 120px; }
            .card-text { font-size: 1.2rem; }
            #schoolLogo { max-height: 50px; }
            .card-header h5, .card-header h6 { font-size: 0.9rem;}
            .main-nav .btn { font-size: 0.8rem; padding: 0.3rem 0.5rem;} /* Adjust button size */
             /* Adjust datatables filter/length */
            div.dataTables_wrapper div.dataTables_filter { text-align: left !important; float: none !important; }
            div.dataTables_wrapper div.dataTables_length {text-align: left !important; float: none !important; margin-top: 0.5rem;}
            div.dataTables_wrapper div.dataTables_filter input { width: auto;}
             #schoolBanner { max-height: 200px; } /* Smaller banner on mobile */
        }
    </style>
</head>
<body>
     <div id="pageLoadingOverlay" class="loading-overlay">
         <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
             <span class="visually-hidden">Loading...</span>
         </div>
     </div>

    <div class="container-fluid mt-3 mb-4">

        <div class="card shadow-sm border-primary position-relative">

            <div class="card-body p-3 p-md-4">

                <img src="https://lh5.googleusercontent.com/d/1fo0zr7v4H4EPKYyS8nK_a6MDawQ1oBS4" alt="‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" id="schoolBanner" class="img-fluid rounded"> <div class="container text-center my-3 main-nav btn-group shadow-sm flex-wrap" role="group" aria-label="Main Navigation"> <button type="button" class="btn btn-outline-primary active" data-target="homePage">
                     <i class="fas fa-home me-1"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                     </button>
                    <button type="button" class="btn btn-outline-primary" data-target="dashboardPage">
                        <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-target="checkinPage">
                        <i class="fas fa-edit me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <button type="button" class="btn btn-outline-primary" data-target="searchPage">
                        <i class="fas fa-search me-1"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                    </button>
                </div>


                <div id="homePage" class="page-section active">

                <div class="container-fluid mt-0 mb-1 bg-light">
                <marquee behavior="scroll" direction="left"
                style="color:	#000000; font-size: 18px;mt-2 mb-2" onmouseover="this.stop();" onmouseout="this.start();"><h6 style="mt-2">
                <h5><img src="https://lh5.googleusercontent.com/d/1cD2nVKNscJg1DJPnkaakah7Nz4ez_BZS" height="12" width="25" >¬†‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á :: ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ KT | Tanasarn Sirak¬†<img src="https://lh5.googleusercontent.com/d/1cD2nVKNscJg1DJPnkaakah7Nz4ez_BZS" height="12" width="25" ></h5></marquee>
                </div>


                    <div id="clock-home" class="alert alert-info text-center shadow-sm py-2 mt-3" role="alert">
                         <i class="fas fa-clock me-2"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...
                     </div>

                    <div class="text mb-4">
                        <div id="info" style="font-size:14px" class="alert alert-warning text-left shadow-sm" role="alert">
                            <i class="fas fa-info-circle me-2"></i><b> ‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</b>
                            <br>1. <b>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</b></br>
                            2. <b>‡∏Ñ‡∏£‡∏π‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π:</b> ‡πÄ‡∏ä‡πâ‡∏≤ <b>07:00-07:20 ‡∏ô.</b> || ‡∏ö‡πà‡∏≤‡∏¢ <b>15:50-17:10 ‡∏ô.</b></br>
                            3. <b>‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</b> ‡πÄ‡∏ä‡πâ‡∏≤ <b>07:00-07:50 ‡∏ô.</b> || ‡∏ö‡πà‡∏≤‡∏¢ <b>15:50-17:10 ‡∏ô.</b></br>
                            4. <b>‡∏Ñ‡∏£‡∏π‡∏£‡∏∞‡∏î‡∏±‡∏ö:</b> ‡πÄ‡∏ä‡πâ‡∏≤ <b>07:40-08:00 ‡∏ô.</b></br>
                            5. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° <button type="button" class="btn btn-sm btn-outline-primary disabled py-0"><i class="fas fa-edit me-1"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ </br>
                            6. ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üëâ <a style="color:#000;cursor:pointer" target="_blank" href="https://line.me/ti/p/3F7VGrqgUr">‡∏≠.‡∏ò‡∏ô‡∏™‡∏≤‡∏£ ‡∏™‡∏µ‡∏£‡∏±‡∏Å‡∏©‡πå</a>
                        </div>
                        <hr>

<!--                         <h5 class="mt-4 mb-3"><i class="fas fa-chart-bar me-2 text-success"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h5>
                        <div class="row g-3 mb-3">
                           <div class="col-md-4">
                               <div class="card text-white bg-primary shadow-sm h-100">
                                   <div class="card-body p-2">
                                       <h6 class="card-title"><i class="fas fa-users me-1"></i> ‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                                       <p class="card-text" id="homeLoggedToday">-</p>
                                        <small class="card-text-small">(‡∏Ñ‡∏ô)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-dark bg-info shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-door-open me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h6>
                                        <p class="card-text" id="homeGateDutyToday">-</p>
                                        <small class="card-text-small">(‡∏Ñ‡∏ô)</small>
                                        </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-dark bg-warning shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-building me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h6>
                                        <p class="card-text" id="homeBuildingDutyToday">-</p>
                                         <small class="card-text-small">(‡∏Ñ‡∏ô)</small>
                                        </div>
                                </div>
                            </div>
                        </div> -->
                        <hr>
						
			<div class="text-center my-4"> <button type="button" class="btn btn-success btn-lg mx-2 mb-2 me-2" id="goToAttendanceBtn">
                        <i class="fas fa-calendar-check me-2"></i>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
                        </button>
                        <a href="https://liff.line.me/1657056127-3k2w6bg7" target="_blank" class="btn btn-info btn-lg mx-2" role="button">
                            <i class="fas fa-user-check me-2"></i>‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </a>
                    </div>
						
						
						
						
                         </div>
                      <div class="text-center mt-4">
                         <a style="color:black;text-decoration:none;font-size:12px"><b><i class="fas fa-chart-line"></i> ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô : </b></a>
                         <a href="https://www.freecounterstat.com" title="hit counters for websites"><img src="https://counter4.optistats.ovh/private/freecounterstat.php?c=uxl7ktjxcfulq4s18eams772gxzgjehu" border="0" title="free hit counter" alt="free hit counter" style="vertical-align: middle;"></a>
                    </div>
                </div>
                <div id="dashboardPage" class="page-section">
                <div id="dashboardPage-t" class="alert alert-info text-center shadow-sm py-2" role="alert">
                           <h5 class="mb-3 mt-3"><i class="fas fa-tachometer-alt me-2 text-primary"></i><b> Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                     </div>


                     <div class="row g-3 mb-3">
                         <div class="col-md-4">
                             <div class="card text-white bg-success shadow-sm h-100">
                                 <div class="card-body p-2">
                                     <h6 class="card-title"><i class="fas fa-users me-1"></i> ‡∏Ñ‡∏£‡∏π‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
                                     <p class="card-text" id="loggedTodayCount">0 / 0</p>
                                     <small class="card-text-small">(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</small>
                                 </div>
                             </div>
                         </div>
                          <div class="col-md-4">
                             <div class="card text-dark bg-info shadow-sm h-100">
                                 <div class="card-body p-2">
                                     <h6 class="card-title"><i class="fas fa-door-open me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</h6>
                                     <p class="card-text" id="gateDutyCount">0</p>
                                     <small class="card-text-small">(‡∏Ñ‡∏ô - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</small>
                                     </div>
                             </div>
                         </div>
                         <div class="col-md-4">
                             <div class="card text-dark bg-warning shadow-sm h-100">
                                 <div class="card-body p-2">
                                     <h6 class="card-title"><i class="fas fa-building me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)</h6>
                                     <p class="card-text" id="buildingDutyCount">0</p>
                                     <small class="card-text-small">(‡∏Ñ‡∏ô - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</small>
                                      </div>
                             </div>
                         </div>
                     </div>
                     <div class="row g-2 mb-3 align-items-center bg-light p-2 rounded border shadow-sm">
                         <div class="col-lg-3 col-md-6">
                             <label for="dashboardDateFilter" class="form-label small mb-0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                             <input type="text" class="form-control form-control-sm" id="dashboardDateFilter" name="dashboardDateFilter">
                         </div>
                         <div class="col-lg-2 col-md-6">
                             <label for="dashboardLevelFilter" class="form-label small mb-0">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</label> <select class="form-select form-select-sm" id="dashboardLevelFilter">
                                 <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                 </select>
                         </div>
                         <div class="col-lg-3 col-md-6">
                             <label for="dashboardDutyFilter" class="form-label small mb-0">‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</label>
                             <select class="form-select form-select-sm" id="dashboardDutyFilter">
                                 <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                 <option value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π</option>
                                 <option value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                                 <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö">‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                                 <option value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î</option>
                                 <option value="‡∏•‡∏≤">‡∏•‡∏≤</option>
                                 <option value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                                 <option value="‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)">‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option>
                             </select>
                         </div>
                          <div class="col-lg-2 col-md-3 d-grid align-self-end">
                              <button class="btn btn-sm btn-primary" id="refreshDashboardBtn" title="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà">
                                  <i class="fas fa-sync-alt"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                              </button>
                          </div>
                          <div class="col-lg-2 col-md-3 align-self-end text-end text-muted small" id="dashboardTableDate">
                               ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: -
                           </div>
                     </div>
                     <div class="table-responsive">
                         <table id="dashboardTable" class="table table-striped table-bordered table-hover" style="width:100%">
                             <thead class="table-light">
                                 <tr>
                                     <th>‡∏£‡∏π‡∏õ</th> <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th> <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th> <th>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th> </tr>
                             </thead>
                             <tbody>
                                 </tbody>
                         </table>
                     </div>
                     </div>
                <div id="checkinPage" class="page-section">

                <div class="row alert alert-info text-center shadow-sm py-2" role="alert" ><b><div class="text-dark mt-1 ml-1 text-center" id="MyClockDisplay" onload="showTime()"></div></b></div>

                    <h5 class="mb-4"><i class="fas fa-edit me-2 text-primary"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h5>
                    <form id="checkinForm" novalidate>
                         <div class="mb-3">
                             <label for="teacherId" style="margin-left: 12px; margin-left: 15px;
                             margin-top: -14px; position: absolute; background-color: white; border: 2px solid white;"><i class="fas fa-id-card me-2 text-primary"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (4 ‡∏ï‡∏±‡∏ß)</label>
                             <input type="tel" class="form-control form-control-xl border border-danger "  style="height: 3.8rem;" id="teacherId" name="teacherId" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (4 ‡∏ï‡∏±‡∏ß)" maxlength="4" inputmode="numeric" pattern="[0-9]*"> <div id="teacherLookupStatus" class="form-text mt-1 small text-muted"></div>
                         </div>

                         <div id="teacherInfo" class="form-section mb-3" style="display:none;">
                              <div class="row align-items-center gx-2 gy-2">
                                 <div class="col-auto">
                                     <img src="https://placehold.co/100x100/adb5bd/ffffff?text=%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%84%E0%B8%A3%E0%B8%B9" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" id="teacherPhoto" class="teacher-photo">
                                 </div>
                                 <div class="col">
                                     <p class="mb-1 small"><strong><i class="fas fa-user fa-fw me-1"></i>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="teacherName"></span></p>
                                     <p class="mb-1 small"><strong><i class="fas fa-chalkboard-teacher fa-fw me-1"></i>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø:</strong> <span id="teacherDepartment"></span></p>
                                     <p class="mb-0 small"><strong><i class="fas fa-user-tie fa-fw me-1"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> <span id="teacherPosition"></span></p>
                                     <input type="hidden" id="hiddenTeacherName" name="teacherName">
                                     <input type="hidden" id="hiddenTeacherDepartment" name="teacherDepartment">
                                 </div>
                             </div>
                         </div>

                        <div id="dutyStatusSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-clipboard-check me-2 text-primary"></i>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusPresent" value="‡∏°‡∏≤" required>
                                <label class="form-check-label" for="statusPresent"> <i class="fas fa-user-check text-success me-1"></i> ‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusLeave" value="‡∏•‡∏≤">
                                <label class="form-check-label" for="statusLeave"> <i class="fas fa-calendar-times text-warning me-1"></i> ‡∏•‡∏≤ </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyStatus" id="statusBusinessTrip" value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">
                                <label class="form-check-label" for="statusBusinessTrip"> <i class="fas fa-plane-departure text-info me-1"></i> ‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ </label>
                            </div>
                            <div id="dutyStatusError" class="invalid-feedback d-block small"></div>
                            <div class="section-loading-overlay" id="dutySubSectionsLoading" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                            </div>
                        </div>

                        <div id="dutyTypeSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-tasks me-2 text-secondary"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyGate" value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">
                                <label class="form-check-label" for="dutyGate"> <i class="fas fa-door-open text-success me-1"></i> ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyBuilding" value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">
                                <label class="form-check-label" for="dutyBuilding"> <i class="fas fa-building text-warning me-1"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyLevel" value="‡∏£‡∏∞‡∏î‡∏±‡∏ö">
                                <label class="form-check-label" for="dutyLevel"> <i class="fas fa-chalkboard-teacher text-info me-1"></i> ‡∏£‡∏∞‡∏î‡∏±‡∏ö </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dutyType" id="dutyPointCommittee" value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î">
                                <label class="form-check-label" for="dutyPointCommittee"> <i class="fas fa-users-cog text-secondary me-1"></i> ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î </label>
                            </div>
                            <div id="dutyTypeError" class="invalid-feedback d-block small"></div>
                        </div>

                        <div id="remarksSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label for="remarks" class="form-label"><i class="fas fa-pencil-alt me-2 text-secondary"></i>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤/‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£"></textarea>
                            <div id="remarksError" class="invalid-feedback d-block small"></div>
                        </div>

                        <div id="locationSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-map-marker-alt me-2 text-danger"></i>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                            <div id="locationInfo" class="form-control form-control-sm bg-light" style="min-height: 35px;">
                                <span class="text-muted small"></span> <button type="button" class="btn btn-xs btn-outline-secondary ms-2 py-0 px-1 float-end" id="getLocationBtn" title="‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"> <i class="fas fa-sync"></i> </button>
                            </div>
                            <input type="hidden" id="latitude" name="latitude"> <input type="hidden" id="longitude" name="longitude">
                            <div id="locationError" class="form-text text-danger mt-1 small"></div>
                        </div>

                        <div id="photoSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label class="form-label"><i class="fas fa-camera me-2 text-info"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡πâ‡∏ô</label>
                            <div class="row g-2 align-items-start">
                                <div class="col-md-6 text-center">
                                    <video id="videoFeed" playsinline autoplay muted class="img-fluid border rounded bg-dark w-100"></video> <canvas id="photoCanvas" style="display:none;"></canvas>
                                </div>
                                <div class="col-md-6 text-center">
                                    <img id="capturedPhotoPreview" src="https://placehold.co/300x200/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢" class="img-fluid border rounded mb-2 captured-photo">
                                    <input type="hidden" id="photoData" name="photoData"> </div>
                            </div>
                            <div class="mt-2 text-center btn-group-camera">
                                <button type="button" class="btn btn-sm btn-info" id="startCameraBtn"><i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                                <button type="button" class="btn btn-sm btn-success" id="capturePhotoBtn" disabled><i class="fas fa-camera-retro me-1"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="resetPhotoBtn" disabled><i class="fas fa-undo me-1"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                            <div id="cameraError" class="form-text text-danger mt-1 text-center small"></div>
                            <div id="photoError" class="invalid-feedback d-block text-center small"></div>
                        </div>
						
						
                        <div id="signatureSection" class="form-section border-top pt-3 mt-3" style="display:none;">
                            <label for="signatureCanvas" class="form-label"><i class="fas fa-signature me-2 text-success"></i>‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠</label>
                            <div class="signature-pad-container"> <canvas id="signatureCanvas"></canvas> </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="resetSignatureBtn"><i class="fas fa-eraser me-1"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</button>
                            <input type="hidden" id="signatureData" name="signatureData"> <div id="signatureError" class="invalid-feedback d-block small"></div>
                        </div>

                        <div id="submitButtonSection" class="form-section d-grid gap-2 mt-4 pt-3 border-top" style="display:none;">
                            <button type="submit" class="btn btn-secondary btn-lg fw-bold shadow" id="submitBtn" disabled>
                            <i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
                            </button>
                        </div>

                         <div id="statusMessage" class="mt-3 small"></div> </form>
                </div>
                 <div id="searchPage" class="page-section">
                    <div id="searchPage-t" class="alert alert-info text-center shadow-sm py-2" role="alert">
                           <h5 class="mb-3 mt-3"><i class="fas fa-search me-2 text-primary"></i><b> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h5>
                     </div>

                    <div class="row g-2 mb-3 align-items-end bg-light p-3 rounded border shadow-sm">
                        <div class="col-md-4">
                            <label for="searchTeacherId" style="margin-left: 12px; margin-left: 15px;
                             margin-top: -14px; position: absolute; background-color: white; border: 2px solid white;"><i class="fas fa-id-card me-2 text-primary"></i>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô (4 ‡∏ï‡∏±‡∏ß)</label>
                            <input type="tel" class="form-control form-control  border border-danger "  style="height: 3.3rem;" id="searchTeacherId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π (4 ‡∏ï‡∏±‡∏ß)" maxlength="4" inputmode="numeric" pattern="[0-9]*">
                        </div>
                        <div class="col-md-3 d-grid">
                            <button class="btn btn-lg btn-primary" id="searchStatsBtn">
                                <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </div>
                        <div class="col-md-5">
                             <div id="searchMessage" class="mt-2 small text-muted"></div>
                        </div>
                    </div>
                    <div id="searchResultArea" style="display: none;">
                        <hr>

                        <div class="row g-3 mb-3">
                            <div class="col-sm-6 col-md-3">
                                <div class="card text-white bg-primary shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-calendar-alt me-1"></i> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h6>
                                        <p class="card-text" id="statsTotalDays">0</p>
                                        <small class="card-text-small">(‡∏ß‡∏±‡∏ô)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <div class="card text-white bg-success shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-user-check me-1"></i> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤</h6>
                                        <p class="card-text" id="statsPresentDays">0</p>
                                         <small class="card-text-small">(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                                    </div>
                                </div>
                            </div>
                             <div class="col-sm-6 col-md-3">
                                <div class="card text-dark bg-warning shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-calendar-times me-1"></i> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≤</h6>
                                        <p class="card-text" id="statsLeaveDays">0</p>
                                         <small class="card-text-small">(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                                     </div>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-3">
                                <div class="card text-white bg-info shadow-sm h-100">
                                    <div class="card-body p-2">
                                        <h6 class="card-title"><i class="fas fa-plane-departure me-1"></i> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h6>
                                         <p class="card-text" id="statsTripDays">0</p>
                                        <small class="card-text-small">(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</small>
                                     </div>
                                 </div>
                             </div>
                         </div>
                        <div id="statsTeacherInfo" class="teacher-profile-card">
                            <div class="row align-items-center gx-3">
                                <div class="col-auto">
                                    <img src="https://placehold.co/80x80/adb5bd/ffffff?text=?" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" id="statsTeacherPhoto" class="rounded-circle">
                                </div>
                                <div class="col-auto">
                                    <h6 class="mb-1" >‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• :: </h6>
                                    <p class="mb-0 small-text text-muted" >‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø :: </p>
                                    <p class="mb-0 small-text text-muted" >‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:: </p>
                                </div>

                                <div class="col-auto">
                                    <h6 class="mb-1" id="statsTeacherName">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</h6>
                                    <p class="mb-0 small-text text-muted" id="statsTeacherDepartment">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</p>
                                    <p class="mb-0 small-text text-muted" id="statsTeacherLevel">N/A</p>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-3 align-items-center bg-light p-2 rounded border">
                           <div class="col-md-5">
                               <label for="statsDateFilter" class="form-label small mb-0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</label>
                               <input type="text" class="form-control form-control-sm" id="statsDateFilter" name="statsDateFilter">
                           </div>
                           <div class="col-md-4">
                               <label for="statsDutyFilter" class="form-label small mb-0">‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</label>
                               <select class="form-select form-select-sm" id="statsDutyFilter">
                                   <option value="" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                   <option value="‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π">‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π</option>
                                   <option value="‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£">‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                                   <option value="‡∏£‡∏∞‡∏î‡∏±‡∏ö">‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                                   <option value="‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î">‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î</option>
                                   <option value="‡∏•‡∏≤">‡∏•‡∏≤</option>
                                   <option value="‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                                   <option value="‡∏°‡∏≤ \(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\)">‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</option> </select>
                           </div>
                            <div class="col-md-3 d-grid align-self-end">
                              <button class="btn btn-sm btn-outline-secondary" id="resetStatsFilterBtn" title="‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á">
                                  <i class="fas fa-times"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                              </button>
                          </div>
                       </div>
                       <h6><i class="fas fa-history me-1"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
                        <div class="table-responsive">
                             <table id="statsTable" class="table table-striped table-bordered table-hover" style="width:100%">
                                 <thead class="table-light">
                                     <tr>
                                         <th>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th> <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th> <th>‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th> </tr>
                                 </thead>
                                 <tbody>
                                     </tbody>
                             </table>
                         </div>
                    </div>
                    </div>
                 <footer class="footer mt-4 text-center">
                    <div class="container">
                         <a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"><i class="fa-solid fa-comments"></i> ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a> || ¬©Ô∏èKT|Tanasarn Sirak (v1)
                     </div>
                 </footer>
                 </div> </div> </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/moment/locale/th.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        // --- Apps Script Web App URL ---
        // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Deploy Apps Script v5.1 (‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß) !!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGDiaBYxsXesotxCB-8sreCkYrRl4hUC0LTqCnXrSp8_QYM8r3YNVyZ3HYDyaHdmGeKw/exec'; // <<--- PASTE YOUR DEPLOYED URL HERE




document.addEventListener('DOMContentLoaded', () => {
    // ... (existing DOMContentLoaded code) ...

    const goToAttendanceBtn = document.getElementById('goToAttendanceBtn');
    if (goToAttendanceBtn) {
        goToAttendanceBtn.addEventListener('click', () => {
            switchPage('checkinPage');
        });
    }
});










        // --- DOM Elements ---
        const mainNavButtons = document.querySelectorAll('.main-nav .btn');
        const pageSections = document.querySelectorAll('.page-section');
        const pageLoadingOverlay = document.getElementById('pageLoadingOverlay');

        // Page Specific Elements
        const homePage = document.getElementById('homePage');
        const dashboardPage = document.getElementById('dashboardPage');
        const checkinPage = document.getElementById('checkinPage');
        const searchPage = document.getElementById('searchPage');

        // Home Page Clock & Stats
         const clockElementHome = document.getElementById('clock-home');
         const homeLoggedTodayEl = document.getElementById('homeLoggedToday');
         const homeGateDutyTodayEl = document.getElementById('homeGateDutyToday');
         const homeBuildingDutyTodayEl = document.getElementById('homeBuildingDutyToday');

        // Dashboard Elements
        const loggedTodayCountEl = document.getElementById('loggedTodayCount');
        const gateDutyCountEl = document.getElementById('gateDutyCount');
        const buildingDutyCountEl = document.getElementById('buildingDutyCount');
        const dashboardDateFilterEl = document.getElementById('dashboardDateFilter');
        const dashboardLevelFilterEl = document.getElementById('dashboardLevelFilter');
        const dashboardDutyFilterEl = document.getElementById('dashboardDutyFilter');
        const refreshDashboardBtn = document.getElementById('refreshDashboardBtn');
        const dashboardTableEl = $('#dashboardTable');
        let dashboardDataTable = null;
        const dashboardTableDateEl = document.getElementById('dashboardTableDate');

        // Check-in Elements
        const MyClockDisplay = document.getElementById('MyClockDisplay'); // For check-in page clock
        const checkinForm = document.getElementById('checkinForm');
        const teacherIdInput = document.getElementById('teacherId');
        const teacherLookupStatus = document.getElementById('teacherLookupStatus');
        const teacherInfoDiv = document.getElementById('teacherInfo');
        const dutyStatusSection = document.getElementById('dutyStatusSection');
        const dutyTypeSection = document.getElementById('dutyTypeSection');
        const remarksSection = document.getElementById('remarksSection');
        const locationSection = document.getElementById('locationSection');
        const signatureSection = document.getElementById('signatureSection');
        const photoSection = document.getElementById('photoSection');
        const submitButtonSection = document.getElementById('submitButtonSection');
        const dutySubSectionsLoading = document.getElementById('dutySubSectionsLoading');
        const teacherPhoto = document.getElementById('teacherPhoto');
        const teacherNameSpan = document.getElementById('teacherName');
        const teacherDepartmentSpan = document.getElementById('teacherDepartment');
        const teacherPositionSpan = document.getElementById('teacherPosition');
        const hiddenTeacherName = document.getElementById('hiddenTeacherName');
        const hiddenTeacherDepartment = document.getElementById('hiddenTeacherDepartment');
        const dutyStatusRadios = document.querySelectorAll('input[name="dutyStatus"]');
        const dutyTypeRadios = document.querySelectorAll('input[name="dutyType"]');
        const remarksInput = document.getElementById('remarks');
        const dutyStatusErrorDiv = document.getElementById('dutyStatusError');
        const dutyTypeErrorDiv = document.getElementById('dutyTypeError');
        const remarksErrorDiv = document.getElementById('remarksError');
        const locationInfoDiv = document.getElementById('locationInfo');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const locationErrorDiv = document.getElementById('locationError');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const resetSignatureBtn = document.getElementById('resetSignatureBtn');
        const signatureDataInput = document.getElementById('signatureData');
        const signatureErrorDiv = document.getElementById('signatureError');
        const videoFeed = document.getElementById('videoFeed');
        const photoCanvas = document.getElementById('photoCanvas');
        const capturedPhotoPreview = document.getElementById('capturedPhotoPreview');
        const photoDataInput = document.getElementById('photoData');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const capturePhotoBtn = document.getElementById('capturePhotoBtn');
        const resetPhotoBtn = document.getElementById('resetPhotoBtn');
        const cameraErrorDiv = document.getElementById('cameraError');
        const photoErrorDiv = document.getElementById('photoError');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Search Statistics Elements
        const searchTeacherIdInput = document.getElementById('searchTeacherId');
        const searchStatsBtn = document.getElementById('searchStatsBtn');
        const searchResultArea = document.getElementById('searchResultArea');
        const statsTotalDaysEl = document.getElementById('statsTotalDays');
        const statsPresentDaysEl = document.getElementById('statsPresentDays');
        const statsLeaveDaysEl = document.getElementById('statsLeaveDays');
        const statsTripDaysEl = document.getElementById('statsTripDays');
        const statsTeacherInfoDiv = document.getElementById('statsTeacherInfo');
        const statsTeacherPhoto = document.getElementById('statsTeacherPhoto');
        const statsTeacherName = document.getElementById('statsTeacherName');
        const statsTeacherDepartment = document.getElementById('statsTeacherDepartment');
        const statsTeacherLevel = document.getElementById('statsTeacherLevel');
        const statsDateFilterEl = document.getElementById('statsDateFilter');
        const statsDutyFilterEl = document.getElementById('statsDutyFilter');
        const resetStatsFilterBtn = document.getElementById('resetStatsFilterBtn');
        const statsTableEl = $('#statsTable');
        let statsDataTable = null;
        const searchMessage = document.getElementById('searchMessage');

        // --- State Variables ---
        let signaturePad; let stream = null; let teacherDataCache = null;
        let locationWatcher = null; let isSubmitting = false;
        //let checkinAllowed = false; // Replaced by more specific logic
        //let currentCheckinWindow = null; // Replaced by more specific logic
        let locationAcquired = false;
        let dashboardDataCache = null;
        let statsDataCache = null;

        // --- Constants ---
        const PLACEHOLDER_IMG = 'https://placehold.co/100x100/adb5bd/ffffff?text=?';
        const DEFAULT_PROFILE_IMG = 'https://placehold.co/40x40/adb5bd/ffffff?text=?';
        const CHECKIN_PHOTO_PLACEHOLDER = 'https://placehold.co/40x40/e9ecef/6c757d?text=N/A';
        const PHOTO_PREVIEW_PLACEHOLDER = 'https://placehold.co/300x200/e9ecef/6c757d?text=%E0%B8%A0%E0%B8%B2%E0%B8%9E%E0%B8%95%E0%B8%B1%E0%B8%A7%E0%B8%AD%E0%B8%A2%E0%B9%88%E0%B8%B2%E0%B8%87';

        // New/Updated specific time constants based on your request
        const GATE_DUTY_MORNING_START = "07:00";
        const GATE_DUTY_MORNING_END = "07:20";
        const GATE_DUTY_AFTERNOON_START = "15:50";
        const GATE_DUTY_AFTERNOON_END = "17:10";

        const BUILDING_CHECK_MORNING_START = "07:00";
        const BUILDING_CHECK_MORNING_END = "07:50";
        const BUILDING_CHECK_AFTERNOON_START = "15:50";
        const BUILDING_CHECK_AFTERNOON_END = "17:10";

        const LEVEL_DUTY_MORNING_START = "07:40";
        const LEVEL_DUTY_MORNING_END = "08:00";

        const POINT_COMMITTEE_DUTY_MORNING_START = "07:40";
        const POINT_COMMITTEE_DUTY_MORNING_END = "09:00";

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!SCRIPT_URL || SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE') || SCRIPT_URL.length < 60) {
                 showSweetAlert('error','Config Error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SCRIPT_URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy Apps Script', false);
                 document.querySelectorAll('button, input, select, textarea').forEach(el => el.disabled = true);
                 return;
            }

            moment.locale('th');
            initializeNavigation();
            // initializeClock(); // showTime() function handles the checkin clock, home clock updates in updateClockAndButtonState
            initializeSignaturePad();
            initializeDashboard();
            initializeSearchStats();
            initializeCheckinFormLogic();

            setInterval(updateClockAndButtonState, 1000);
            window.addEventListener('resize', resizeCanvas);
            switchPage('homePage');
            showTime(); // Start the check-in page clock if that's the mechanism
        });

        // --- Helper Functions ---

        function showLoading(show) {
            if (show) {
                 pageLoadingOverlay.classList.add('active');
            } else {
                 setTimeout(() => pageLoadingOverlay.classList.remove('active'), 200);
             }
        }

        function showSweetAlert(icon, title, html = '', timerOrDuration = true) {
            const config = { icon: icon, title: title, html: html, confirmButtonText: '‡∏õ‡∏¥‡∏î' };
            if (typeof timerOrDuration === 'boolean' && timerOrDuration) { // Original boolean logic for auto-timer
                config.timer = icon === 'success' ? 2500 : 4000;
                config.timerProgressBar = true;
            } else if (typeof timerOrDuration === 'number') { // Allow specific duration
                config.timer = timerOrDuration;
                config.timerProgressBar = true;
            }
            // If timerOrDuration is false, no timer is set.
            Swal.fire(config);
        }


        function showSuccessSweetAlert(checkinTime, teacherName, photoUrl) {
             let imageHtml = '';
             if (photoUrl && photoUrl !== CHECKIN_PHOTO_PLACEHOLDER) { // CHECKIN_PHOTO_PLACEHOLDER might not be relevant here if photoDataUrl is used
                 imageHtml = `<img src="${photoUrl}" alt="Check-in Photo" style="max-width:150px; max-height:150px; margin-top:10px; border-radius:5px; border: 1px solid #ddd;">`;
             }
            Swal.fire({
                icon: 'success',
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                html: `<p class="mb-1"><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${checkinTime}</p>
                       <p class="mb-2"><strong>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${teacherName}</p>
                       ${imageHtml}`,
                confirmButtonText: '‡∏õ‡∏¥‡∏î',
                timer: 3500,
                timerProgressBar: true
            });
        }

        function formatThaiDateTimeCustom(dateInput) {
            try {
                const date = moment(dateInput);
                if (!date.isValid()) { return 'Invalid Date'; }
                const thaiYear = date.year() + 543;
                 return date.format('DD/MMM/') + thaiYear + date.format(', HH:mm:ss ‡∏ô.');
             } catch (error) {
                console.error("Error formatting custom date:", dateInput, error);
                return 'Invalid Date';
            }
        }

         function formatThaiDate(dateInput) {
             try {
                 const date = moment(dateInput);
                 if (!date.isValid()) { return 'Invalid Date'; }
                 const thaiYear = date.year() + 543;
                 return date.format('dddd D MMMM ') + thaiYear;
             } catch (error) {
                 console.error("Error formatting date (short):", dateInput, error);
                 return 'Invalid Date';
             }
         }

        // --- Navigation Logic ---
        function initializeNavigation() {
            mainNavButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPageId = button.getAttribute('data-target');
                    switchPage(targetPageId);
                });
            });
        }

        function switchPage(targetPageId) {
            showLoading(true);

            pageSections.forEach(section => section.classList.remove('active'));
            mainNavButtons.forEach(btn => btn.classList.remove('active'));

            const targetSection = document.getElementById(targetPageId);
            const targetButton = document.querySelector(`.main-nav .btn[data-target="${targetPageId}"]`);

            if (targetSection) {
                targetSection.classList.add('active');
                console.log(`Switched to page: ${targetPageId}`);

                if (targetPageId === 'homePage') {
                     loadHomepageStats();
                } else if (targetPageId === 'dashboardPage') {
                    loadDashboardData();
                } else if (targetPageId === 'checkinPage') {
                     resizeCanvas();
                }
            }

            if (targetButton) {
                targetButton.classList.add('active');
            }
            setTimeout(() => showLoading(false), 100);
        }

        // --- Homepage Stats Function ---
        async function loadHomepageStats() {
             if (!homePage.classList.contains('active') || SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) return;

             homeLoggedTodayEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
             homeGateDutyTodayEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
             homeBuildingDutyTodayEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

             const todayDate = moment().format('YYYY-MM-DD');
             const url = `${SCRIPT_URL}?action=getDashboardData&date=${todayDate}`;

             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`Server error (${response.status})`);
                 const data = await response.json();

                 if (data.status === 'success' && data.counts) {
                     homeLoggedTodayEl.textContent = data.counts.loggedToday || 0;
                     homeGateDutyTodayEl.textContent = data.counts.gateDutyLogged || 0;
                     homeBuildingDutyTodayEl.textContent = data.counts.buildingDutyLogged || 0;
                 } else {
                      throw new Error(data.message || 'Failed to load homepage stats');
                 }
             } catch (error) {
                 console.error('Error loading homepage stats:', error);
                 homeLoggedTodayEl.textContent = 'Error';
                 homeGateDutyTodayEl.textContent = 'Error';
                 homeBuildingDutyTodayEl.textContent = 'Error';
             }
        }


        // --- Dashboard Functions ---
        function initializeDashboard() {
             $(dashboardDateFilterEl).daterangepicker({
                 singleDatePicker: true, showDropdowns: true, autoApply: true,
                 locale: {
                     format: 'YYYY-MM-DD', applyLabel: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', cancelLabel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                     daysOfWeek: moment.weekdaysMin(), monthNames: moment.monthsShort(),
                     firstDay: moment.localeData('th').firstDayOfWeek()
                 },
                 maxDate: moment()
             }, function(start, end, label) {
                 loadDashboardData();
             });
             $(dashboardDateFilterEl).data('daterangepicker').setStartDate(moment());

            dashboardDataTable = dashboardTableEl.DataTable({
                language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
                columns: [
                    {
                        data: 'teacherPhotoUrl', orderable: false, searchable: false,
                        render: function(data, type, row) {
                            const imgSrc = data || DEFAULT_PROFILE_IMG;
                            return `<img src="${imgSrc}" class="table-img dashboard-table-img" alt="‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π" onerror="this.onerror=null; this.src='${DEFAULT_PROFILE_IMG}';" data-img-src="${imgSrc}">`;
                        }
                    },
                    { data: 'teacherName' },
                    { data: 'level', defaultContent: 'N/A' },
                    { data: 'dutyType' },
                    {
                        data: 'timestamp',
                        render: function(data) { return formatThaiDateTimeCustom(data); }
                    }
                ],
                order: [[4, 'desc']], responsive: true, pageLength: 10,
                lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] ],
                 dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                      '<"row dt-row"<"col-sm-12"tr>>' +
                      '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                 drawCallback: function(settings) { addDashboardImageEventListeners(); }
            });

            dashboardDutyFilterEl.addEventListener('change', filterDashboardTable);
            dashboardLevelFilterEl.addEventListener('change', filterDashboardTable);
            refreshDashboardBtn.addEventListener('click', loadDashboardData);
        }

        async function loadDashboardData() {
            if (!dashboardPage.classList.contains('active') || SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) return;
            showLoading(true);
            const selectedDate = $(dashboardDateFilterEl).data('daterangepicker').startDate.format('YYYY-MM-DD');
            dashboardTableDateEl.textContent = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(selectedDate)}`;

            const url = `${SCRIPT_URL}?action=getDashboardData&date=${selectedDate}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Server error (${response.status}): ${response.statusText}`);
                 const data = await response.json();
                 if (data.status === 'success') {
                     updateDashboardCards(data.counts);
                     dashboardDataCache = data.recentLogs || [];
                     populateLevelFilter(dashboardLevelFilterEl, dashboardDataCache);
                     filterDashboardTable();
                 } else {
                     throw new Error(data.message || 'Failed to load dashboard data');
                 }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showSweetAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Dashboard ‡πÑ‡∏î‡πâ: ${error.message}`, false);
                if (dashboardDataTable) dashboardDataTable.clear().draw();
                updateDashboardCards(null);
                 dashboardDataCache = [];
                 dashboardTableDateEl.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
            } finally {
                showLoading(false);
            }
        }

         function updateDashboardCards(counts) {
             if (counts) {
                 loggedTodayCountEl.textContent = `${counts.loggedToday || 0} / ${counts.totalTeachers || 0}`;
                 gateDutyCountEl.textContent = `${counts.gateDutyLogged || 0}`;
                 buildingDutyCountEl.textContent = `${counts.buildingDutyLogged || 0}`;
             } else {
                loggedTodayCountEl.textContent = '0 / 0';
                gateDutyCountEl.textContent = '0';
                buildingDutyCountEl.textContent = '0';
             }
        }

         function populateLevelFilter(selectElement, data) {
             if (!selectElement || !data) return;
             const existingLevels = new Set();
             data.forEach(item => {
                 if (item.level && item.level !== 'N/A') existingLevels.add(item.level);
             });
             $(selectElement).find('option:not([value="all"])').remove();
             existingLevels.forEach(level => {
                 $(selectElement).append($('<option>', { value: level, text: level }));
             });
         }

         function filterDashboardTable() {
            if (!dashboardDataTable || dashboardDataCache === null) return;
            const selectedDuty = dashboardDutyFilterEl.value;
            const selectedLevel = dashboardLevelFilterEl.value;
            let filteredData = dashboardDataCache;
            if (selectedLevel !== 'all') {
                 filteredData = filteredData.filter(log => log.level === selectedLevel);
            }
            if (selectedDuty !== 'all') {
                 filteredData = filteredData.filter(log => log.dutyType === selectedDuty);
            }
            dashboardDataTable.clear().rows.add(filteredData).draw();
         }

        function addDashboardImageEventListeners() {
             $('#dashboardTable tbody').off('click', 'img.dashboard-table-img').on('click', 'img.dashboard-table-img', function() {
                const src = $(this).data('img-src');
                 if (src && src !== DEFAULT_PROFILE_IMG) {
                    Swal.fire({ imageUrl: src, imageHeight: 400, imageAlt: '‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏π', confirmButtonText: '‡∏õ‡∏¥‡∏î' });
                 }
            });
        }


        // --- Check-in Form Functions ---
        function initializeCheckinFormLogic() {
             if (teacherIdInput) {
                 teacherIdInput.addEventListener('input', handleTeacherIdInput);
                 teacherIdInput.addEventListener('paste', (e) => { setTimeout(handleTeacherIdInput, 0); });
             }
             if (dutyStatusSection) dutyStatusSection.addEventListener('change', handleDutyStatusChange);
             if(getLocationBtn) getLocationBtn.addEventListener('click', initializeGeolocation);
             if(startCameraBtn) startCameraBtn.addEventListener('click', startCamera);
             if(capturePhotoBtn) capturePhotoBtn.addEventListener('click', capturePhoto);
             if(resetPhotoBtn) resetPhotoBtn.addEventListener('click', resetPhoto);
             if (checkinForm) checkinForm.addEventListener('submit', handleCheckinFormSubmit);
            addCompletionCheckListeners();
            hideAllCheckinSections();
        }

        // Function to check if current time is within a given window
        function isWithinWindow(currentTimeStr, startTimeStr, endTimeStr) {
            return currentTimeStr >= startTimeStr && currentTimeStr <= endTimeStr;
        }

        // Helper function to get selected duty type value
        function getSelectedDutyType() {
            const selectedDutyRadio = document.querySelector('input[name="dutyType"]:checked');
            return selectedDutyRadio ? selectedDutyRadio.value : null;
        }

        // New helper function for specific duty time validation
        function isCheckinAllowedForSelectedDuty() {
            const now = new Date();
            const currentTimeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const selectedDuty = getSelectedDutyType();
            let currentGeneralWindow = null;

            const currentStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value;
            if (currentStatus === '‡∏•‡∏≤' || currentStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
                return { allowed: true, windowText: '', generalWindow: null }; // Always allowed for these statuses
            }

            if (currentStatus === '‡∏°‡∏≤' && !selectedDuty) {
                 return { allowed: false, windowText: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà', generalWindow: null };
            }

            switch (selectedDuty) {
                case '‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π':
                    if (isWithinWindow(currentTimeStr, GATE_DUTY_MORNING_START, GATE_DUTY_MORNING_END)) {
                        currentGeneralWindow = 'morning';
                        return { allowed: true, windowText: `‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡πÄ‡∏ä‡πâ‡∏≤ ${GATE_DUTY_MORNING_START}-${GATE_DUTY_MORNING_END})`, generalWindow: currentGeneralWindow };
                    }
                    if (isWithinWindow(currentTimeStr, GATE_DUTY_AFTERNOON_START, GATE_DUTY_AFTERNOON_END)) {
                        currentGeneralWindow = 'afternoon';
                        return { allowed: true, windowText: `‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡∏ö‡πà‡∏≤‡∏¢ ${GATE_DUTY_AFTERNOON_START}-${GATE_DUTY_AFTERNOON_END})`, generalWindow: currentGeneralWindow };
                    }
                    return { allowed: false, windowText: `‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π (‡πÄ‡∏ä‡πâ‡∏≤ ${GATE_DUTY_MORNING_START}-${GATE_DUTY_MORNING_END} ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ö‡πà‡∏≤‡∏¢ ${GATE_DUTY_AFTERNOON_START}-${GATE_DUTY_AFTERNOON_END})`, generalWindow: null };
                case '‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£':
                    if (isWithinWindow(currentTimeStr, BUILDING_CHECK_MORNING_START, BUILDING_CHECK_MORNING_END)) {
                        currentGeneralWindow = 'morning';
                        return { allowed: true, windowText: `‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÄ‡∏ä‡πâ‡∏≤ ${BUILDING_CHECK_MORNING_START}-${BUILDING_CHECK_MORNING_END})`, generalWindow: currentGeneralWindow };
                    }
                    if (isWithinWindow(currentTimeStr, BUILDING_CHECK_AFTERNOON_START, BUILDING_CHECK_AFTERNOON_END)) {
                        currentGeneralWindow = 'afternoon';
                        return { allowed: true, windowText: `‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ö‡πà‡∏≤‡∏¢ ${BUILDING_CHECK_AFTERNOON_START}-${BUILDING_CHECK_AFTERNOON_END})`, generalWindow: currentGeneralWindow };
                    }
                    return { allowed: false, windowText: `‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ (‡πÄ‡∏ä‡πâ‡∏≤ ${BUILDING_CHECK_MORNING_START}-${BUILDING_CHECK_MORNING_END} ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ö‡πà‡∏≤‡∏¢ ${BUILDING_CHECK_AFTERNOON_START}-${BUILDING_CHECK_AFTERNOON_END})`, generalWindow: null };
                case '‡∏£‡∏∞‡∏î‡∏±‡∏ö':
                    if (isWithinWindow(currentTimeStr, LEVEL_DUTY_MORNING_START, LEVEL_DUTY_MORNING_END)) {
                        currentGeneralWindow = 'morning';
                        return { allowed: true, windowText: `‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡πÄ‡∏ä‡πâ‡∏≤ ${LEVEL_DUTY_MORNING_START}-${LEVEL_DUTY_MORNING_END})`, generalWindow: currentGeneralWindow };
                    }
                    return { allowed: false, windowText: `‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡πÄ‡∏ä‡πâ‡∏≤ ${LEVEL_DUTY_MORNING_START}-${LEVEL_DUTY_MORNING_END})`, generalWindow: null };
                case '‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î':
                    if (isWithinWindow(currentTimeStr, POINT_COMMITTEE_DUTY_MORNING_START, POINT_COMMITTEE_DUTY_MORNING_END)) {
                        currentGeneralWindow = 'morning';
                        return { allowed: true, windowText: `‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î (‡πÄ‡∏ä‡πâ‡∏≤ ${POINT_COMMITTEE_DUTY_MORNING_START}-${POINT_COMMITTEE_DUTY_MORNING_END})`, generalWindow: currentGeneralWindow };
                    }
                    return { allowed: false, windowText: `‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î (‡πÄ‡∏ä‡πâ‡∏≤ ${POINT_COMMITTEE_DUTY_MORNING_START}-${POINT_COMMITTEE_DUTY_MORNING_END})`, generalWindow: null };
                default:
                    return { allowed: false, windowText: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', generalWindow: null };
            }
        }

        function updateClockAndButtonState() {
            const now = new Date();
            const year = now.getFullYear() + 543;
            const optsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const optsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const thaiDate = now.toLocaleDateString('th-TH', optsDate).replace(String(now.getFullYear()), String(year));
            const thaiTime = now.toLocaleTimeString('th-TH', optsTime);
            const clockText = `<i class="fas fa-clock me-2"></i> ${thaiDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${thaiTime} ‡∏ô.`;

            if(homePage.classList.contains('active') && clockElementHome) clockElementHome.innerHTML = clockText;
            // MyClockDisplay is updated by showTime() function from original script

            if (isSubmitting || !checkinPage.classList.contains('active')) return;
            updateSubmitButtonDisplay(); // This will now use isCheckinAllowedForSelectedDuty
        }


        function handleTeacherIdInput() {
             const currentVal = teacherIdInput.value.replace(/\D/g,'');
             teacherIdInput.value = currentVal;
             teacherLookupStatus.textContent = '';
             teacherLookupStatus.classList.remove('text-danger', 'text-success');

             if (currentVal.length === 4) {
                 showLoadingAndFetchTeacher(currentVal);
             } else if (currentVal.length > 0) {
                  teacherLookupStatus.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ 4 ‡∏ï‡∏±‡∏ß';
                  hideAllCheckinSections(false);
             } else {
                  hideAllCheckinSections(true);
             }
        }

         function showLoadingAndFetchTeacher(teacherId) {
            teacherLookupStatus.textContent = '';
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π...', text: `‡∏£‡∏´‡∏±‡∏™: ${teacherId}`,
                allowOutsideClick: false, allowEscapeKey: false,
                didOpen: () => { Swal.showLoading(); }
            });
            hideAllCheckinSections(false);
            fetchTeacherData(teacherId);
        }

        async function fetchTeacherData(teacherId) {
            if (!teacherId || SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) {
                if (SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) {
                     showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set', false);
                }
                return;
            }
            teacherDataCache = null;

            // This SweetAlert is already called by showLoadingAndFetchTeacher
            // Swal.fire({
            //     title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π...', text: `‡∏£‡∏´‡∏±‡∏™: ${teacherId}`,
            //     allowOutsideClick: false, allowEscapeKey: false,
            //     didOpen: () => { Swal.showLoading(); }
            // });

            try {
                const lookupUrl = `${SCRIPT_URL}?action=getTeacherInfo&id=${encodeURIComponent(teacherId)}`;
                const response = await fetch(lookupUrl);
                if (!response.ok) throw new Error(`Server Connection Error (${response.status})`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);
                 if (!data.found || !data.teacher) {
                     throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ <a style="color:#0515f5;cursor:pointer" target="_blank" href="https://line.me/ti/p/3F7VGrqgUr">‡∏≠.‡∏ò‡∏ô‡∏™‡∏≤‡∏£ ‡∏™‡∏µ‡∏£‡∏±‡∏Å‡∏©‡πå</a>');
                 }

                if (Swal.isLoading()) Swal.close();
                 Swal.fire({
                    icon: 'success', title: '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    html: `<strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> ${data.teacher.name || 'N/A'}`,
                    timer: 2000, timerProgressBar: true, showConfirmButton: false
                });

                teacherDataCache = data.teacher;
                teacherNameSpan.textContent = data.teacher.name || 'N/A';
                teacherDepartmentSpan.textContent = data.teacher.department || 'N/A';
                teacherPositionSpan.textContent = data.teacher.position || 'N/A';
                teacherPhoto.src = data.teacher.photoUrl || PLACEHOLDER_IMG;
                teacherPhoto.onerror = () => { teacherPhoto.src = PLACEHOLDER_IMG; };
                hiddenTeacherName.value = data.teacher.name || '';
                hiddenTeacherDepartment.value = data.teacher.department || '';
                teacherLookupStatus.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${data.teacher.name || 'N/A'}`;
                teacherLookupStatus.classList.remove('text-danger');
                teacherLookupStatus.classList.add('text-success');
                showBaseInfoAndDutyStatus();

            } catch (error) {
                 if (Swal.isLoading()) Swal.close();
                 teacherLookupStatus.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message.substring(0, 100)}`; // Prevent overly long messages
                 teacherLookupStatus.classList.add('text-danger');
                 teacherLookupStatus.classList.remove('text-success');
                 hideAllCheckinSections(false);
                 teacherIdInput.focus();
                 teacherDataCache = null;
                 showSweetAlert('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î / ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${error.message}`, false);
             } finally {
                 if (Swal.isLoading()) Swal.close();
             }
        }

        function showBaseInfoAndDutyStatus() {
             teacherInfoDiv.style.display = 'block';
             dutyStatusSection.style.display = 'block';
             dutyStatusRadios.forEach(radio => radio.checked = false);
             hideDutySubSections();
             checkFormCompletion();
        }

        function hideAllCheckinSections(clearTeacherId = true) {
            teacherInfoDiv.style.display = 'none';
            dutyStatusSection.style.display = 'none';
            hideDutySubSections();

            if (teacherDataCache) teacherDataCache = null;
            hiddenTeacherName.value = ''; hiddenTeacherDepartment.value = '';
            locationAcquired = false;

            if (clearTeacherId) {
                teacherIdInput.value = '';
                teacherLookupStatus.textContent = '';
                teacherLookupStatus.classList.remove('text-danger', 'text-success');
            }

             clearValidationErrors();
             statusMessage.innerHTML = '';
             stopCameraStream();
             if (signaturePad) signaturePad.clear();
             signatureDataInput.value = '';
             photoDataInput.value = '';
             capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
             startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
             startCameraBtn.disabled = false;
             capturePhotoBtn.disabled = true;
             resetPhotoBtn.disabled = true;
             cameraErrorDiv.textContent = ''; photoErrorDiv.textContent = '';
             latitudeInput.value = ''; longitudeInput.value = '';
             locationInfoDiv.querySelector('span').textContent = '';
             const mapLink = locationInfoDiv.querySelector('a.map-link'); if(mapLink) mapLink.remove();
             checkFormCompletion();
        }

         function hideDutySubSections() {
            dutyTypeSection.style.display = 'none';
            remarksSection.style.display = 'none';
            locationSection.style.display = 'none';
            signatureSection.style.display = 'none';
            photoSection.style.display = 'none';
            submitButtonSection.style.display = 'none';
            dutyTypeRadios.forEach(r => r.checked = false);
            remarksInput.value = '';
        }

        // Inside your <script> tag in PCTeacherattendance v1.html

async function handleDutyStatusChange(event) {
    if (!event.target || event.target.name !== 'dutyStatus') return;

    const selectedStatus = event.target.value;
    console.log("Duty status changed to:", selectedStatus);

    clearValidationErrors(['dutyStatusError']);
    dutySubSectionsLoading.style.display = 'flex';
    hideDutySubSections(); // Hide everything below first

    // Reset fields that depend on status before showing new sections
    dutyTypeRadios.forEach(r => { r.checked = false; r.required = false; });
    remarksInput.value = ''; remarksInput.required = false;
    locationAcquired = false; latitudeInput.value = ''; longitudeInput.value = ''; locationErrorDiv.textContent = '';
    locationInfoDiv.querySelector('span').textContent = '';
    const mapLinkOld = locationInfoDiv.querySelector('a.map-link'); if (mapLinkOld) mapLinkOld.remove();
    if (signaturePad) signaturePad.clear(); signatureDataInput.value = ''; signatureErrorDiv.textContent = '';
    photoDataInput.value = ''; photoErrorDiv.textContent = ''; capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
    startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á'; capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true; cameraErrorDiv.textContent = '';
    startCameraBtn.disabled = false;
    stopCameraStream();

    await new Promise(resolve => setTimeout(resolve, 50)); // Short delay for UI update

    if (selectedStatus === '‡∏°‡∏≤') {
        // NEW: Proactive Time Check when '‡∏°‡∏≤' is selected
        const now = new Date();
        const currentTimeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        let isCurrentlyInAnyAllowedWindow = false;
        let specificDutyWindowMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ!!"; // Default message

        // Check against all "‡∏°‡∏≤" duty windows
        if (isWithinWindow(currentTimeStr, GATE_DUTY_MORNING_START, GATE_DUTY_MORNING_END) ||
            isWithinWindow(currentTimeStr, GATE_DUTY_AFTERNOON_START, GATE_DUTY_AFTERNOON_END) ||
            isWithinWindow(currentTimeStr, BUILDING_CHECK_MORNING_START, BUILDING_CHECK_MORNING_END) ||
            isWithinWindow(currentTimeStr, BUILDING_CHECK_AFTERNOON_START, BUILDING_CHECK_AFTERNOON_END) ||
            isWithinWindow(currentTimeStr, LEVEL_DUTY_MORNING_START, LEVEL_DUTY_MORNING_END) ||
            isWithinWindow(currentTimeStr, POINT_COMMITTEE_DUTY_MORNING_START, POINT_COMMITTEE_DUTY_MORNING_END)) {
            isCurrentlyInAnyAllowedWindow = true;
        }

        if (!isCurrentlyInAnyAllowedWindow) {
            // Construct a more detailed message if needed, or use a general one
            //let detailedMessage = "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î<br><br><u>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</u><br>";
            //detailedMessage += `- ‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π: <span class="math-inline">\{GATE\_DUTY\_MORNING\_START\}\-</span>{GATE_DUTY_MORNING_END} ‡∏´‡∏£‡∏∑‡∏≠ <span class="math-inline">\{GATE\_DUTY\_AFTERNOON\_START\}\-</span>{GATE_DUTY_AFTERNOON_END}<br>`;
            //detailedMessage += `- ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£: <span class="math-inline">\{BUILDING\_CHECK\_MORNING\_START\}\-</span>{BUILDING_CHECK_MORNING_END} ‡∏´‡∏£‡∏∑‡∏≠ <span class="math-inline">\{BUILDING\_CHECK\_AFTERNOON\_START\}\-</span>{BUILDING_CHECK_AFTERNOON_END}<br>`;
            //detailedMessage += `- ‡∏£‡∏∞‡∏î‡∏±‡∏ö: <span class="math-inline">\{LEVEL\_DUTY\_MORNING\_START\}\-</span>{LEVEL_DUTY_MORNING_END}<br>`;
            //detailedMessage += `- ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î: <span class="math-inline">\{POINT\_COMMITTEE\_DUTY\_MORNING\_START\}\-</span>{POINT_COMMITTEE_DUTY_MORNING_END}`;

            //showSweetAlert('warning', '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ', detailedMessage, false); // false for no auto-timer
            // Optionally, you might want to uncheck the '‡∏°‡∏≤' radio button or guide the user.
            // For now, it just shows the alert. The form sections for '‡∏°‡∏≤' will still show.
			//Swal.fire({
				  //title: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ !!",
				  //text: "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î !",
				  //icon: "error",
				  //showCancelButton: false,
				 // confirmButtonColor: "#3085d6",
				 // cancelButtonColor: "#d33",
				 // confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á, ‡∏â‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à!",
				  // position: 'top',
				  //allowOutsideClick : false
				//}).then((result) => {
				  //if (result.isConfirmed) {
					///switchPage('homePage');
				 // }
				//});
				
				Swal.fire({
				  title: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ !!",
				  text: "‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î !",
				  icon: "error",
				  showDenyButton: true,
				  showCancelButton: false,
				  confirmButtonText: "‡∏ï‡∏Å‡∏•‡∏á, ‡∏â‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à!",
				  denyButtonText: `‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô`
				 
				}).then((result) => {
				  /* Read more about isConfirmed, isDenied below */
				  if (result.isConfirmed) {
					switchPage('homePage');
				  } else if (result.isDenied) {
				   window.location.href = `https://sites.google.com/view/time-pcschool/Time-record`
				   //window.open("https://liff.line.me/1657056127-3k2w6bg7");
					
				  }
				});
				
				
				
			}

		
        // END NEW: Proactive Time Check

        dutyTypeSection.style.display = 'block';
        locationSection.style.display = 'block';
        signatureSection.style.display = 'block';
        photoSection.style.display = 'block';
        submitButtonSection.style.display = 'grid'; // Use grid for d-grid
        dutyTypeRadios.forEach(r => r.required = true);
        remarksInput.required = false;
        initializeGeolocation(); // Start getting location
        resizeCanvas(); // Ensure signature pad is sized correctly
    } else if (selectedStatus === '‡∏•‡∏≤' || selectedStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
        remarksSection.style.display = 'block';
        submitButtonSection.style.display = 'grid'; // Use grid for d-grid
        remarksInput.required = true;
        dutyTypeRadios.forEach(r => r.required = false);
    } else {
        // Should not happen if a radio is selected, but hide submit just in case
        submitButtonSection.style.display = 'none';
    }

    dutySubSectionsLoading.style.display = 'none'; // Hide spinner
    checkFormCompletion(); // Update submit button state after showing/hiding sections
}

         function initializeGeolocation() {
             if (!locationSection || locationSection.style.display === 'none') return;
             locationInfoDiv.querySelector('span').innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
             locationErrorDiv.textContent = ''; latitudeInput.value = ''; longitudeInput.value = '';
             locationAcquired = false;
             clearValidationErrors(['locationError']);
             checkFormCompletion();

             if ('geolocation' in navigator) {
                 if (locationWatcher) navigator.geolocation.clearWatch(locationWatcher);
                 navigator.geolocation.getCurrentPosition(
                     (pos) => {
                         latitudeInput.value = pos.coords.latitude.toFixed(8);
                         longitudeInput.value = pos.coords.longitude.toFixed(8);
                         locationAcquired = true;
                         locationInfoDiv.querySelector('span').innerHTML = `<i class="fas fa-check-circle text-success me-1"></i> ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                          const mapLinkUrl = `https://maps.google.com/?q=${pos.coords.latitude},${pos.coords.longitude}`;
                          let link = locationInfoDiv.querySelector('a.map-link');
                          if (!link) {
                              link = document.createElement('a');
                              link.target = '_blank'; link.rel = 'noopener noreferrer';
                              link.classList.add('ms-1', 'small', 'map-link', 'text-decoration-none');
                              link.innerHTML = '<i class="fas fa-external-link-alt"></i>';
                              link.title = '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
                              locationInfoDiv.appendChild(link);
                          }
                          link.href = mapLinkUrl;
                         checkFormCompletion();
                     },
                     (err) => {
                         handleLocationError(err); locationAcquired = false; checkFormCompletion();
                     },
                     { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                 );
             } else {
                 handleLocationError({ code: -1, message: 'Geolocation ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ' });
                 locationAcquired = false; checkFormCompletion();
             }
         }

         function handleLocationError(error) {
             console.error('Geolocation Error:', error);
             let msg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ';
             switch (error.code) {
                 case error.PERMISSION_DENIED: msg += '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'; break;
                 case error.POSITION_UNAVAILABLE: msg += '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ'; break;
                 case error.TIMEOUT: msg += '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'; break;
                 case -1: msg = error.message; break;
                 default: msg += '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'; break;
             }
             locationInfoDiv.querySelector('span').innerHTML = '<i class="fas fa-times-circle text-danger me-1"></i> ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
             locationErrorDiv.textContent = msg;
             latitudeInput.value = ''; longitudeInput.value = '';
             const mapLink = locationInfoDiv.querySelector('a.map-link'); if(mapLink) mapLink.remove();
         }

         function initializeSignaturePad() {
              setTimeout(() => {
                 if (!signatureCanvas) { console.error("Signature canvas element not found."); return; }
                 resizeCanvas();
                 signaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                 if (resetSignatureBtn) {
                     resetSignatureBtn.addEventListener('click', () => {
                         if(signaturePad) signaturePad.clear();
                         signatureDataInput.value = '';
                         clearValidationErrors(['signatureError']); checkFormCompletion();
                     });
                 }
                 signatureCanvas.addEventListener('pointerdown', () => {
                      if(signaturePad && !signaturePad.isEmpty()) clearValidationErrors(['signatureError']);
                 });
                 signaturePad.addEventListener("endStroke", () => {
                     if (signaturePad) {
                         signatureDataInput.value = signaturePad.isEmpty() ? '' : signaturePad.toDataURL('image/jpeg', 0.8).split(',')[1];
                         checkFormCompletion();
                         if(!signaturePad.isEmpty()) clearValidationErrors(['signatureError']);
                     }
                 });
              }, 100);
         }

         function resizeCanvas() {
            if (!signatureCanvas || !signatureCanvas.offsetParent) return;
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const container = signatureCanvas.parentElement;
             if (!container || container.offsetWidth === 0 || container.offsetHeight === 0) return;
            signatureCanvas.width = container.offsetWidth * ratio;
            signatureCanvas.height = container.offsetHeight * ratio;
            signatureCanvas.style.width = `${container.offsetWidth}px`;
            signatureCanvas.style.height = `${container.offsetHeight}px`;
            const ctx = signatureCanvas.getContext("2d");
             if (ctx) {
                ctx.scale(ratio, ratio);
                 if (signaturePad) {
                    const data = signaturePad.toData(); signaturePad.clear(); signaturePad.fromData(data);
                 }
             }
        }

        function stopCameraStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop()); stream = null;
                if (videoFeed) {
                    videoFeed.srcObject = null; videoFeed.style.display = 'none'; videoFeed.load();
                 }
            }
        }

        async function startCamera() {
            if (!photoSection || photoSection.style.display === 'none') return;
            cameraErrorDiv.textContent = ''; photoErrorDiv.textContent = '';
            clearValidationErrors(['cameraError', 'photoError']);
            stopCameraStream();
            await new Promise(resolve => setTimeout(resolve, 100));

            startCameraBtn.disabled = true;
            startCameraBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î...';

            try {
                 const constraints = { video: { facingMode: 'user' }, audio: false };
                 stream = await navigator.mediaDevices.getUserMedia(constraints);
                 if (videoFeed) {
                     videoFeed.srcObject = stream; videoFeed.style.display = 'block'; await videoFeed.play();
                     capturePhotoBtn.disabled = false; resetPhotoBtn.disabled = true;
                     startCameraBtn.innerHTML = '<i class="fas fa-sync me-1"></i> ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏•‡πâ‡∏≠‡∏á'; checkFormCompletion();
                 }
                 if (capturedPhotoPreview) capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
                 if (photoDataInput) photoDataInput.value = '';
            } catch (err) {
                console.error("Camera Access Error:", err);
                let msg = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${err.name})`;
                if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") msg = "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á";
                else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") msg = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á";
                else if (err.name === "NotReadableError" || err.name === "TrackStartError") msg = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤";
                cameraErrorDiv.textContent = msg;
                capturePhotoBtn.disabled = true; resetPhotoBtn.disabled = true;
                startCameraBtn.innerHTML = '<i class="fas fa-video me-1"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á';
                 if (videoFeed) videoFeed.style.display = 'none';
                stopCameraStream(); checkFormCompletion();
             } finally {
                 startCameraBtn.disabled = false;
             }
         }

         function capturePhoto() {
             if (!stream || !stream.active || !videoFeed || videoFeed.readyState < videoFeed.HAVE_METADATA) {
                 cameraErrorDiv.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô'; return;
              }
             clearValidationErrors(['photoError']);
             const videoWidth = videoFeed.videoWidth; const videoHeight = videoFeed.videoHeight;
             if (!videoWidth || !videoHeight) { cameraErrorDiv.textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠'; return; }

             if (photoCanvas) {
                 photoCanvas.width = videoWidth; photoCanvas.height = videoHeight;
                 const ctx = photoCanvas.getContext('2d');
                 if (stream.getVideoTracks()[0]?.getSettings()?.facingMode === 'user') {
                      ctx.translate(videoWidth, 0); ctx.scale(-1, 1);
                 }
                 ctx.drawImage(videoFeed, 0, 0, videoWidth, videoHeight);
                 const dataUrl = photoCanvas.toDataURL('image/jpeg', 0.8);
                 if (capturedPhotoPreview) capturedPhotoPreview.src = dataUrl;
                 if (photoDataInput) photoDataInput.value = dataUrl.split(',')[1];
		// --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô videoFeed ---
		 if (videoFeed) videoFeed.style.display = 'none';
                 // -----------------------------------------
             }
             resetPhotoBtn.disabled = false; capturePhotoBtn.disabled = true;
             checkFormCompletion(); clearValidationErrors(['photoError']);
        }

         function resetPhoto() {
             clearValidationErrors(['photoError']);
             if (photoDataInput) photoDataInput.value = '';
 	     if (videoFeed) videoFeed.style.display = 'block';
             if (capturedPhotoPreview) capturedPhotoPreview.src = PHOTO_PREVIEW_PLACEHOLDER;
             resetPhotoBtn.disabled = true;
             if (stream && stream.active) capturePhotoBtn.disabled = false;
             else capturePhotoBtn.disabled = true;
             checkFormCompletion();
        }

        function addCompletionCheckListeners() {
             dutyTypeRadios.forEach(r => r.addEventListener('change', checkFormCompletion));
             remarksInput.addEventListener('input', checkFormCompletion);
             dutyStatusRadios.forEach(r => r.addEventListener('change', checkFormCompletion));
        }

        function checkFormCompletion() {
            const selectedStatusRadio = document.querySelector('input[name="dutyStatus"]:checked');
            const selectedStatus = selectedStatusRadio ? selectedStatusRadio.value : null;
            let isComplete = false;

            if (!teacherDataCache || !selectedStatus) {
                isComplete = false;
            } else if (selectedStatus === '‡∏°‡∏≤') {
                const dutyTypeSelected = document.querySelector('input[name="dutyType"]:checked');
                const signatureDone = signaturePad && !signaturePad.isEmpty() && signatureDataInput.value;
                const photoTaken = photoDataInput.value;
                const locationDone = latitudeInput.value && longitudeInput.value && locationAcquired;
                isComplete = !!(dutyTypeSelected && locationDone && signatureDone && photoTaken);
            } else if (selectedStatus === '‡∏•‡∏≤' || selectedStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') {
                isComplete = remarksInput.value.trim() !== '';
            }
            updateSubmitButtonDisplay(isComplete);
            return isComplete;
        }

        function updateSubmitButtonDisplay(isFormComplete = checkFormCompletion()) {
            const isSectionVisible = submitButtonSection && submitButtonSection.style.display !== 'none';

            if (!isSectionVisible) {
                submitBtn.disabled = true;
                submitBtn.classList.replace('btn-primary', 'btn-secondary');
                submitBtn.innerHTML = `<i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö`;
                return;
            }

            const { allowed, windowText: timeWindowMessage, generalWindow } = isCheckinAllowedForSelectedDuty();
            const currentStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value;

            if ((currentStatus === '‡∏°‡∏≤' && allowed && isFormComplete) || ((currentStatus === '‡∏•‡∏≤' || currentStatus === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') && isFormComplete) ) {
                submitBtn.disabled = false;
                submitBtn.classList.replace('btn-secondary', 'btn-primary');
                const dutyTypeText = getSelectedDutyType() || '';
                const generalWindowText = generalWindow === 'morning' ? '‡πÄ‡∏ä‡πâ‡∏≤' : (generalWindow === 'afternoon' ? '‡∏ö‡πà‡∏≤‡∏¢' : '');
                let submitButtonText = `<i class="fas fa-paper-plane me-2"></i> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`;
                if (currentStatus === '‡∏°‡∏≤') {
                     submitButtonText += ` ${dutyTypeText} ${generalWindowText ? '(‡∏£‡∏≠‡∏ö' + generalWindowText + ')' : ''}`;
                }
                submitBtn.innerHTML = submitButtonText;
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.replace('btn-primary', 'btn-secondary');
                if (!isFormComplete) {
                    submitBtn.innerHTML = `<i class="fas fa-times-circle me-2"></i> ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö`;
                } else { // Complete but outside window for '‡∏°‡∏≤' status
                    submitBtn.innerHTML = `<i class="fas fa-clock me-2"></i> ${timeWindowMessage}`;
                }
            }
        }


         function validateForm() {
             clearValidationErrors();
             let isValid = true;
             const selectedStatusRadio = document.querySelector('input[name="dutyStatus"]:checked');
             const statusValue = selectedStatusRadio ? selectedStatusRadio.value : null;

             if (!teacherDataCache) { showSweetAlert('warning', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); isValid = false; teacherIdInput.focus(); }
             else if (!statusValue) { dutyStatusErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'; isValid = false; dutyStatusSection.scrollIntoView({ behavior: 'smooth', block: 'center' });}
             else if (statusValue === '‡∏°‡∏≤') {
                 if (!document.querySelector('input[name="dutyType"]:checked')) { dutyTypeErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'; isValid = false; if(isValid) dutyTypeSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  if (!latitudeInput.value || !longitudeInput.value || !locationAcquired) { locationErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏Å‡∏î <i class="fas fa-sync"></i> ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô)'; isValid = false; if(isValid) locationSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  if (signaturePad.isEmpty() || !signatureDataInput.value) { signatureErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠'; isValid = false; if(isValid) signatureSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                  if (!photoDataInput.value) { photoErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'; isValid = false; if(isValid) photoSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
             } else if ((statusValue === '‡∏•‡∏≤' || statusValue === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£')) {
                 if (!remarksInput.value.trim()) { remarksErrorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)'; isValid = false; if(isValid) remarksSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
             }

             if (isValid) { // Point 3: SweetAlert if outside time range on submit
                const selectedStatus = document.querySelector('input[name="dutyStatus"]:checked')?.value;
                if (selectedStatus === '‡∏°‡∏≤') { // Time validation only for '‡∏°‡∏≤'
                    const { allowed, windowText } = isCheckinAllowedForSelectedDuty();
                    if (!allowed) {
                        showSweetAlert('warning', '‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', windowText); // Show specific time window message
                        isValid = false;
                    }
                }
            }
             return isValid;
         }

         function clearValidationErrors(exceptIds = []) {
             const errorDivs = checkinForm.querySelectorAll('.form-text.text-danger, .invalid-feedback');
             errorDivs.forEach(div => { if (!exceptIds.includes(div.id)) div.textContent = ''; });
         }

        async function handleCheckinFormSubmit(event) {
            event.preventDefault();
             if (isSubmitting) return;
            if (!validateForm()) return; // ValidateForm now includes the time check SweetAlert
             if (SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) { showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set', false); return; }

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                html: `‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${teacherDataCache?.name || 'N/A'}<br>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${document.querySelector('input[name="dutyStatus"]:checked')?.value || 'N/A'}<br>‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ${getSelectedDutyType() || (document.querySelector('input[name="dutyStatus"]:checked')?.value !== '‡∏°‡∏≤' ? 'N/A' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏')}`,
                icon: 'question', showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
                confirmButtonText: ' <i class="fas fa-check"></i> ‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ', cancelButtonText: '<i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    isSubmitting = true; statusMessage.innerHTML = ''; submitBtn.disabled = true;
                    const formData = new FormData(checkinForm);

                     if (formData.get('dutyStatus') === '‡∏°‡∏≤') {
                         formData.delete('remarks');
                     } else {
                          formData.delete('dutyType'); formData.delete('latitude'); formData.delete('longitude');
                          formData.delete('signatureData'); formData.delete('photoData');
                     }
                    formData.append('clientTimestamp', new Date().toISOString());

                     let fetchSuccess = false; let successData = null; let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';

                    try {
                        const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                        const fetchResult = await response.json();
                        if (fetchResult.status === 'success') {
                             fetchSuccess = true;
                             const now = new Date(); const thaiDateTime = formatThaiDateTimeCustom(now);
                             const photoBase64 = formData.get('dutyStatus') === '‡∏°‡∏≤' ? formData.get('photoData') : null;
                             const photoDataUrl = photoBase64 ? `data:image/jpeg;base64,${photoBase64}` : null;
                             successData = { thaiDateTime, status: formData.get('dutyStatus'), photoDataUrl };
                        } else {
                             errorMessage = fetchResult.message || '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; throw new Error(errorMessage);
                         }
                    } catch (error) {
                        console.error('Submit Error:', error); errorMessage = error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ';
                    } finally {
                        if (Swal.isVisible() && Swal.isLoading()) Swal.close();
                        isSubmitting = false; submitBtn.disabled = false;

                        if (fetchSuccess && successData) { // Point 5: Redirect to Dashboard
                            Swal.fire({
                                icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                                html: `<p class="mb-1"><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${successData.thaiDateTime}</p>
                                       <p class="mb-1"><strong>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ${teacherDataCache?.name || 'N/A'}</p>
                                       ${successData.photoDataUrl ? `<img src="${successData.photoDataUrl}" alt="Check-in Photo" style="max-width:150px; max-height:150px; margin-top:10px; border-radius:5px; border: 1px solid #ddd;">` : ''}
                                       <p class="mt-2 mb-0"><small>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Dashboard...</small></p>`,
                                confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á', timer: 3500, timerProgressBar: true,
                                willClose: () => {
                                    resetCheckinForm();
                                    switchPage('dashboardPage');
                                }
                            });
                        } else {
                            showSweetAlert('error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMessage}`, false);
                            teacherIdInput.value = '';
                            hideAllCheckinSections(false);
                            teacherLookupStatus.textContent = `‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
                            teacherLookupStatus.className = 'form-text mt-1 small text-danger';
                            teacherIdInput.focus();
                            checkFormCompletion();
                        }
                    }
                }
            });
        }

        function resetCheckinForm() {
             checkinForm.reset();
             hideAllCheckinSections(true);
             if (checkinPage.classList.contains('active')) {
                  window.scrollTo({ top: 0, behavior: 'smooth' });
             }
             updateClockAndButtonState();
        }

        // --- Search Statistics Functions ---
        function initializeSearchStats() {
             $(statsDateFilterEl).daterangepicker({
                 autoUpdateInput: false, showDropdowns: true,
                 locale: {
                     format: 'DD/MM/YYYY', separator: ' - ', applyLabel: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', cancelLabel: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                     fromLabel: '‡∏à‡∏≤‡∏Å', toLabel: '‡∏ñ‡∏∂‡∏á', daysOfWeek: moment.weekdaysMin(), monthNames: moment.months(),
                     firstDay: moment.localeData('th').firstDayOfWeek()
                 },
                 ranges: {
                    '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ': [moment(), moment()], '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    '7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î': [moment().subtract(6, 'days'), moment()], '30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î': [moment().subtract(29, 'days'), moment()],
                    '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ': [moment().startOf('month'), moment().endOf('month')],
                    '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                 }
             });
             $(statsDateFilterEl).on('apply.daterangepicker', function(ev, picker) {
                 $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
                 filterStatsTable();
             });
             $(statsDateFilterEl).on('cancel.daterangepicker', function(ev, picker) {
                 $(this).val(''); filterStatsTable();
             });

             statsDataTable = statsTableEl.DataTable({
                 language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
                 columns: [
                     {
                         data: 'checkinPhotoUrl', orderable: false, searchable: false,
                         render: function(data, type, row) {
                             const imgSrc = data || CHECKIN_PHOTO_PLACEHOLDER;
                             return `<img src="${imgSrc}" class="table-img stats-table-img" alt="‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" onerror="this.onerror=null; this.src='${CHECKIN_PHOTO_PLACEHOLDER}';" data-img-src="${imgSrc}">`;
                         }
                     },
                     { data: 'level', defaultContent: 'N/A' },
                     { data: 'dutyOrStatus' },
                     { data: 'timestamp', render: function(data) { return formatThaiDateTimeCustom(data); } }
                 ],
                 order: [[3, 'desc']], responsive: true, pageLength: 10,
                 lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"] ],
                  dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                       '<"row dt-row"<"col-sm-12"tr>>' +
                       '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                  drawCallback: function(settings) { addStatsImageEventListeners(); }
             });

            if(searchStatsBtn) searchStatsBtn.addEventListener('click', handleSearchStats);
            if(searchTeacherIdInput) searchTeacherIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSearchStats(); });
            statsDutyFilterEl.addEventListener('change', filterStatsTable);
            resetStatsFilterBtn.addEventListener('click', resetStatsFilters);
         }

        async function handleSearchStats() {
            const teacherId = searchTeacherIdInput.value.trim();
            searchMessage.textContent = ''; searchResultArea.style.display = 'none';
            statsDataCache = null; resetStatsFilters();

            if (!teacherId || teacherId.length !== 4 || !/^\d+$/.test(teacherId)) {
                searchMessage.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π 4 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)'; searchMessage.className = 'mt-2 small text-danger';
                Swal.fire({ icon: 'warning', title: '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏π 4 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)', timer: 3000, timerProgressBar: true });
                return;
            }
             if (SCRIPT_URL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL_HERE')) { showSweetAlert('error', 'Config Error', 'SCRIPT_URL not set', false); return; }

            searchMessage.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            searchMessage.className = 'mt-2 small text-muted'; showLoading(true);

            try {
                 const url = `${SCRIPT_URL}?action=getTeacherStats&id=${encodeURIComponent(teacherId)}`;
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`Server error (${response.status}): ${response.statusText}`);
                 const data = await response.json();

                 if (data.status === 'success') {
                     statsDataCache = data.checkinHistory || [];
                     displayTeacherStats(data.teacherInfo, statsDataCache);
                     searchMessage.textContent = `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π: ${data.teacherInfo?.name || teacherId}`;
                     searchMessage.className = 'mt-2 small text-success';
                     Swal.fire({ icon: 'success', title: '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', html: `‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π: <strong>${data.teacherInfo?.name || teacherId}</strong>`, timer: 3000, timerProgressBar: true, showConfirmButton:false });
                 } else if (data.status === 'notfound') {
                      searchMessage.textContent = data.message || `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏£‡∏´‡∏±‡∏™ ${teacherId}`;
                      searchMessage.className = 'mt-2 small text-warning';
                      if (statsDataTable) statsDataTable.clear().draw();
                      Swal.fire({ icon: 'warning', title: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', text: data.message || `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ${teacherId}`, timer: 3000, timerProgressBar: true, showConfirmButton:false });
                 } else {
                     throw new Error(data.message || 'Failed to load teacher statistics');
                 }
            } catch (error) {
                 console.error('Error loading teacher stats:', error);
                 searchMessage.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                 searchMessage.className = 'mt-2 small text-danger';
                  if (statsDataTable) statsDataTable.clear().draw();
                 Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ: ${error.message}` });
            } finally {
                 showLoading(false);
            }
        }

         function displayTeacherStats(teacherInfo, history) {
            if (!teacherInfo || !searchResultArea) {
                if(searchResultArea) searchResultArea.style.display = 'none';
                if(statsDataTable) statsDataTable.clear().draw();
                return;
             }
             statsTeacherPhoto.src = teacherInfo.photoUrl || PLACEHOLDER_IMG;
             statsTeacherPhoto.onerror = () => { statsTeacherPhoto.src = PLACEHOLDER_IMG; };
             statsTeacherName.textContent = teacherInfo.name || 'N/A';
             statsTeacherDepartment.textContent = teacherInfo.department || 'N/A';
             statsTeacherLevel.textContent = `${teacherInfo.level || 'N/A'}`;

             let totalDaysSet = new Set(); let presentCount = 0; let leaveCount = 0; let tripCount = 0;
             if (history && history.length > 0) {
                 history.forEach(log => {
                     totalDaysSet.add(moment(log.timestamp).format('YYYY-MM-DD'));
                     const status = log.dutyOrStatus || '';
                     if (status === '‡∏•‡∏≤') leaveCount++;
                     else if (status === '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£') tripCount++;
                     else if (status.includes('‡∏°‡∏≤') || status === '‡πÄ‡∏ß‡∏£‡∏¢‡∏∑‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π' || status === '‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' || status === '‡∏£‡∏∞‡∏î‡∏±‡∏ö' || status === '‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏∏‡∏î') presentCount++;
                 });
             }
             statsTotalDaysEl.textContent = totalDaysSet.size;
             statsPresentDaysEl.textContent = presentCount;
             statsLeaveDaysEl.textContent = leaveCount;
             statsTripDaysEl.textContent = tripCount;

             if (statsDataTable) {
                 statsDataTable.clear().rows.add(history || []).order([3, 'desc']).draw();
             }
             searchResultArea.style.display = 'block';
             filterStatsTable();
        }

        function addStatsImageEventListeners() {
             $('#statsTable tbody').off('click', 'img.stats-table-img').on('click', 'img.stats-table-img', function() {
                const src = $(this).data('img-src');
                 if (src && src !== CHECKIN_PHOTO_PLACEHOLDER) {
                    Swal.fire({ imageUrl: src, imageHeight: 400, imageAlt: '‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', confirmButtonText: '‡∏õ‡∏¥‡∏î' });
                 }
            });
        }

         function filterStatsTable() {
             if (!statsDataTable || statsDataCache === null) return;
             const selectedDuty = statsDutyFilterEl.value;
             //const dateRange = $(statsDateFilterEl).data('daterangepicker');
             //const startDate = dateRange && dateRange.startDate && dateRange.startDate.isValid() ? dateRange.startDate.startOf('day') : null;
             //const endDate = dateRange && dateRange.endDate && dateRange.endDate.isValid() ? dateRange.endDate.endOf('day') : null;

	     const dateInputVal = $(statsDateFilterEl).val(); // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á input ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
		let startDate = null;
		let endDate = null;
		
		if (dateInputVal) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á input ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
		    const dateRange = $(statsDateFilterEl).data('daterangepicker');
		    if (dateRange && dateRange.startDate && dateRange.startDate.isValid()) {
		        startDate = dateRange.startDate.startOf('day');
		    }
		    if (dateRange && dateRange.endDate && dateRange.endDate.isValid()) {
		        endDate = dateRange.endDate.endOf('day');
		    }
		}
		// ‡∏´‡∏≤‡∏Å dateInputVal ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤, startDate ‡πÅ‡∏•‡∏∞ endDate ‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô null
	 
             $.fn.dataTable.ext.search.pop(); // Clear previous search functions
             $.fn.dataTable.ext.search.push(
                 function(settings, data, dataIndex) {
                     const dutyStatusInRow = data[2] || ''; // Column for Duty/Status
                     const timestampInRow = statsDataCache[dataIndex].timestamp; // Original ISO timestamp
                     const recordDate = moment(timestampInRow);

                     let dutyMatch = true;
                     if (selectedDuty) {
                         // For "‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)" we need an exact match.
                         // For other duty types, also exact match.
                         if (selectedDuty === "‡∏°‡∏≤ \\(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏\\)") { // Check for the escaped value if that's what your dropdown sends
                             dutyMatch = (dutyStatusInRow === "‡∏°‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)");
                         } else {
                             dutyMatch = (dutyStatusInRow === selectedDuty);
                         }
                     }

                     let dateMatch = true;
                     if (startDate && endDate && recordDate.isValid()) {
                         dateMatch = recordDate.isBetween(startDate, endDate, undefined, '[]');
                     } else if ($(statsDateFilterEl).val() && (!startDate || !endDate)) { // If datepicker has text but dates are invalid
                         dateMatch = false; // Consider it a non-match if filter is attempted with invalid dates
                     }


                     return dutyMatch && dateMatch;
                 }
             );
             statsDataTable.draw();
         }

         function resetStatsFilters() {
            $(statsDateFilterEl).val('');
            const drp = $(statsDateFilterEl).data('daterangepicker');
            if (drp) { // Ensure daterangepicker is initialized
                drp.setStartDate(moment()); // Reset to avoid issues, or clear them
                drp.setEndDate(moment());
                $(statsDateFilterEl).val(''); // Explicitly clear the input
            }
            statsDutyFilterEl.value = "";
            filterStatsTable(); // This will redraw with no filters active
         }

    </script>

<script language="javascript">
    // This function is from your original script to display clock on check-in page
    function showTime(){
        const now = new Date();
        const thday = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
        const thmonth = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];

        const h = now.getHours();
        const m = now.getMinutes();
        const s = now.getSeconds();

        const formattedH = (h < 10 ? "0" : "") + h;
        const formattedM = (m < 10 ? "0" : "") + m;
        const formattedS = (s < 10 ? "0" : "") + s;

        const time = "‡∏ß‡∏±‡∏ô" + thday[now.getDay()]+ "‡∏ó‡∏µ‡πà "+ now.getDate()+ " " +
                     thmonth[now.getMonth()]+ " " + "‡∏û.‡∏®."+ (now.getFullYear()+543) + // Corrected year
                     " ‡πÄ‡∏ß‡∏•‡∏≤  " +  formattedH + ":" + formattedM + ":" + formattedS + " ‡∏ô.";

        if (MyClockDisplay) { // Check if element exists
             MyClockDisplay.innerText = time;
             // MyClockDisplay.textContent = time; // innerText is usually sufficient
        }
        setTimeout(showTime, 1000);
    }
    // showTime(); // Called in DOMContentLoaded now
</script>

</body>
</html>
